<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Browse Books - BookMarket</title>
        <link rel="stylesheet" href="../css/styles.css" />
        <!-- Additional CSS for Browse page -->
        <style>
            /* Browse Page Specific Styles */
            .browse-container {
                max-width: var(--container-width);
                margin: 0 auto;
                padding: 1rem;
            }

            .bangla-brand {
                font-family: "Courier New", monospace;
                font-weight: bold;
                color: #556b2f;
                text-transform: uppercase;
                letter-spacing: 2px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
                font-size: 1.8rem;
                margin-bottom: 1rem;
                text-align: center;
            }

            .bangla-brand::before {
                content: "‚ñ≤";
                color: #ff8c00;
                margin-right: 10px;
                font-size: 1.5rem;
                text-shadow: none;
            }

            /* Main Layout */
            .browse-layout {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            /* Search Section - Full Width */
            .search-section {
                background-color: white;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 1.5rem;
            }

            .search-box {
                display: flex;
                max-width: 600px;
                margin: 0 auto;
                gap: 0.5rem;
            }

            .search-input {
                flex: 1;
                padding: 0.8rem 1rem;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                font-size: 1rem;
            }

            .search-input:focus {
                outline: none;
                border-color: var(--primary-color);
            }

            .search-button {
                padding: 0 1.5rem;
                background-color: var(--primary-color);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                white-space: nowrap;
            }

            .search-button:hover {
                background-color: #3a5a97;
            }

            /* Filters Section - Full Width */
            .filters-section {
                background-color: white;
                padding: 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 1.5rem;
            }

            .filters-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .filters-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--dark-color);
            }

            .mobile-filter-toggle {
                display: none;
                padding: 0.5rem 1rem;
                background-color: var(--primary-color);
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 0.9rem;
                cursor: pointer;
            }

            .mobile-filter-toggle:hover {
                background-color: #3a5a97;
            }

            .filters-content {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .filter-group {
                display: flex;
                flex-direction: column;
            }

            .filter-group label {
                font-weight: 500;
                color: var(--dark-color);
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
            }

            .filter-group select,
            .filter-group input[type="number"] {
                padding: 0.7rem;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 0.9rem;
            }

            .filter-group select:focus,
            .filter-group input[type="number"]:focus {
                outline: none;
                border-color: var(--primary-color);
            }

            .price-range-group {
                grid-column: span 2;
            }

            .price-range-inputs {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .price-range-separator {
                color: #666;
                font-weight: 500;
                font-size: 0.9rem;
            }

            .price-range-inputs input {
                flex: 1;
                padding: 0.7rem;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 0.9rem;
            }

            .filter-buttons {
                grid-column: 1 / -1;
                display: flex;
                gap: 1rem;
                justify-content: flex-end;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #f0f0f0;
            }

            .filter-buttons .btn {
                padding: 0.7rem 1.5rem;
                border-radius: 4px;
                font-weight: 500;
                border: none;
                cursor: pointer;
                font-size: 0.9rem;
            }

            .btn-apply-filters {
                background-color: var(--primary-color);
                color: white;
            }

            .btn-apply-filters:hover {
                background-color: #3a5a97;
            }

            .btn-reset-filters {
                background-color: #f8f9fa;
                border: 1px solid var(--border-color);
                color: var(--dark-color);
            }

            .btn-reset-filters:hover {
                background-color: #e9ecef;
            }

            /* Results Header */
            .results-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                padding: 0.5rem 0;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .books-count {
                font-size: 1rem;
                color: var(--dark-color);
                font-weight: 500;
            }

            .view-toggle {
                display: flex;
                gap: 0.5rem;
            }

            .view-toggle button {
                padding: 0.5rem;
                border: 1px solid var(--border-color);
                background-color: white;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .view-toggle button.active {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .view-toggle button:hover {
                border-color: var(--primary-color);
            }

            /* Books Grid */
            .books-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            /* List View Styles */
            .books-grid.list-view {
                grid-template-columns: 1fr;
            }

            .books-grid.list-view .book-card {
                display: flex;
                align-items: center;
            }

            .books-grid.list-view .book-image {
                width: 120px;
                height: 160px;
                flex-shrink: 0;
            }

            .books-grid.list-view .book-details {
                flex: 1;
                display: flex;
                align-items: center;
                gap: 2rem;
                padding: 1.5rem;
            }

            .books-grid.list-view .book-info {
                flex: 1;
            }

            .books-grid.list-view .book-actions {
                flex-shrink: 0;
                width: 200px;
            }

            .books-grid.list-view .book-info h3 {
                margin-bottom: 0.3rem;
            }

            .books-grid.list-view .book-info .author {
                margin-bottom: 0.5rem;
            }

            .books-grid.list-view .book-info .condition {
                margin-bottom: 0.5rem;
            }

            .books-grid.list-view .book-info .price {
                margin-bottom: 0;
            }

            .book-card {
                background-color: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                border: 1px solid #f0f0f0;
                transition: all 0.2s ease;
            }

            .book-card:hover {
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px);
            }

            .book-image {
                height: 280px;
                overflow: hidden;
                position: relative;
            }

            .book-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.2s ease;
                display: block;
            }

            .book-image img.loading {
                opacity: 0.7;
            }

            .book-image img.error {
                display: none;
            }

            .book-card:hover .book-image img {
                transform: scale(1.02);
            }

            .book-image .placeholder-image {
                width: 100%;
                height: 100%;
                display: none;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background-color: #f0f0f0;
                color: #777;
                font-size: 0.9rem;
                text-align: center;
                padding: 1rem;
            }

            .book-image .placeholder-image.show {
                display: flex;
            }

            .book-image .placeholder-image i {
                font-size: 2rem;
                margin-bottom: 0.5rem;
                color: #999;
            }

            .book-image .placeholder-image span {
                font-size: 0.8rem;
                line-height: 1.2;
                word-break: break-word;
            }

            .book-details {
                padding: 1.5rem;
            }

            .book-details h3 {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
                color: var(--dark-color);
                font-weight: 600;
                line-height: 1.3;
            }

            .author {
                font-size: 0.9rem;
                color: #666;
                margin-bottom: 0.8rem;
                font-style: italic;
            }

            .condition {
                font-size: 0.85rem;
                margin-bottom: 0.8rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .condition-badge {
                background-color: #e8f5e8;
                color: #2d5a2d;
                padding: 0.3rem 0.6rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
            }

            .price {
                font-size: 1.3rem;
                font-weight: 700;
                color: var(--primary-color);
                margin-bottom: 1.2rem;
            }

            .book-actions {
                display: flex;
                gap: 0.8rem;
            }

            .btn-add-cart,
            .btn-view {
                padding: 0.7rem 1rem;
                font-size: 0.9rem;
                flex: 1;
                text-align: center;
                border-radius: 4px;
                cursor: pointer;
                border: none;
                font-weight: 500;
                text-decoration: none;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .btn-add-cart {
                background-color: var(--secondary-color);
                color: white;
            }

            .btn-add-cart:hover {
                background-color: #d35400;
                transform: translateY(-1px);
            }

            .btn-view {
                background-color: transparent;
                border: 1px solid var(--primary-color);
                color: var(--primary-color);
            }

            .btn-view:hover {
                background-color: var(--primary-color);
                color: white;
                transform: translateY(-1px);
            }

            /* Pagination */
            .pagination {
                display: flex;
                justify-content: center;
                margin-top: 2rem;
                gap: 0.5rem;
            }

            .pagination-button {
                padding: 0.7rem 1rem;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                background-color: white;
                cursor: pointer;
                font-weight: 500;
                min-width: 40px;
                transition: all 0.2s ease;
            }

            .pagination-button:hover {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
                transform: translateY(-1px);
            }

            .pagination-button.active {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            /* Responsive styles */
            @media screen and (max-width: 768px) {
                .browse-container {
                    padding: 0.5rem;
                }

                .mobile-filter-toggle {
                    display: block;
                }

                .filters-content {
                    display: none;
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }

                .filters-content.show {
                    display: grid;
                }

                .price-range-group {
                    grid-column: span 1;
                }

                .price-range-inputs {
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .price-range-separator {
                    display: none;
                }

                .filter-buttons {
                    flex-direction: column;
                }

                .search-box {
                    flex-direction: column;
                }

                .search-input {
                    border-radius: 6px;
                }

                .search-button {
                    border-radius: 6px;
                    padding: 0.8rem;
                }

                .books-grid {
                    grid-template-columns: repeat(
                        auto-fill,
                        minmax(250px, 1fr)
                    );
                    gap: 1rem;
                }

                .results-header {
                    flex-direction: column;
                    align-items: flex-start;
                }
            }

            @media screen and (max-width: 480px) {
                .books-grid {
                    grid-template-columns: 1fr;
                }

                .book-actions {
                    flex-direction: column;
                }

                .search-section,
                .filters-section {
                    padding: 1rem;
                }

                .book-card {
                    margin-bottom: 1rem;
                }
            }

            /* Loading and message styles */
            .loading-placeholder {
                text-align: center;
                padding: 40px 20px;
                color: #666;
            }

            .loading-placeholder p {
                font-size: 18px;
                margin: 0;
            }

            .no-books-message {
                text-align: center;
                padding: 40px 20px;
                color: #666;
            }

            .no-books-message p {
                font-size: 18px;
                margin: 0;
            }

            .pagination-button.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .pagination-ellipsis {
                padding: 8px 12px;
                color: #666;
            }
        </style>
        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
    </head>
    <body>
        <!-- Navbar (Common Customer Navbar) -->
        <nav class="navbar">
            <!-- Navbar will be generated by customer-navbar.js -->
        </nav>

        <!-- Browse Books Content -->
        <div class="browse-container">
            <!-- New Responsive Layout -->
            <div class="browse-layout">
                <!-- Search Section - Full Width -->
                <div class="search-section">
                    <div class="search-box">
                        <input
                            type="text"
                            class="search-input"
                            placeholder="Search by title, author, ISBN..."
                        />
                        <button class="search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Filters Section - Full Width -->
                <div class="filters-section">
                    <div class="filters-header">
                        <h3 class="filters-title">Filter Books</h3>
                        <button
                            class="mobile-filter-toggle"
                            id="mobile-filter-toggle"
                        >
                            <i class="fas fa-filter"></i> Show Filters
                        </button>
                    </div>

                    <div class="filters-content" id="filters-content">
                        <div class="filter-group">
                            <label for="category">Category</label>
                            <select id="category">
                                <option value="">All Categories</option>
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="condition">Book Condition</label>
                            <select id="condition">
                                <option value="">Any Condition</option>
                                <!-- Conditions will be loaded dynamically -->
                            </select>
                        </div>

                        <div class="filter-group price-range-group">
                            <label for="price-range">Price Range (‡ß≥)</label>
                            <div class="price-range-inputs">
                                <input
                                    type="number"
                                    id="min-price"
                                    placeholder="Min"
                                    min="0"
                                    value="0"
                                />
                                <span class="price-range-separator">to</span>
                                <input
                                    type="number"
                                    id="max-price"
                                    placeholder="Max"
                                    min="0"
                                    value="5000"
                                />
                            </div>
                        </div>

                        <div class="filter-group">
                            <label for="sort-by">Sort By</label>
                            <select id="sort-by">
                                <option value="newest">Newest First</option>
                                <option value="a-z">Title (A-Z)</option>
                                <option value="z-a">Title (Z-A)</option>
                                <option value="price-low">
                                    Price (Low to High)
                                </option>
                                <option value="price-high">
                                    Price (High to Low)
                                </option>
                            </select>
                        </div>

                        <div class="filter-buttons">
                            <button
                                class="btn btn-apply-filters"
                                id="apply-filters"
                            >
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button
                                class="btn btn-reset-filters"
                                id="reset-filters"
                            >
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>

                    <!-- Results Header -->
                    <div class="results-header">
                        <div class="books-count">
                            Showing <span id="books-total">0</span> books
                        </div>
                        <div class="view-toggle">
                            <button class="active" title="Grid View">
                                <i class="fas fa-th"></i>
                            </button>
                            <button title="List View">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Books Grid - Will be populated from backend -->
                    <div class="books-grid" id="books-grid">
                        <!-- Books will be loaded dynamically -->
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="pagination">
                        <!-- Pagination will be generated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer (Same as index.html) -->
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-top">
                    <div class="footer-column">
                        <h3>BookMarket</h3>
                        <p>
                            Your one-stop destination for buying and selling
                            books online. Find your next favorite book or give
                            your old books a new home.
                        </p>
                        <div class="social-links">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        </div>
                    </div>
                    <div class="footer-column">
                        <h3>Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="../index.html">Home</a></li>
                            <li><a href="browse.html">Browse Books</a></li>
                            <li><a href="sell.html">Sell Books</a></li>
                            <li><a href="about.html">About Us</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul class="footer-links">
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">FAQs</a></li>
                            <li><a href="#">Shipping Policy</a></li>
                            <li><a href="#">Return Policy</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Contact</h3>
                        <ul class="contact-info">
                            <li>
                                <i class="fas fa-map-marker-alt"></i> 123 Book
                                Street, Dhaka, Bangladesh
                            </li>
                            <li>
                                <i class="fas fa-phone"></i> +880 123 456789
                            </li>
                            <li>
                                <i class="fas fa-envelope"></i>
                                support@bookmarket.com
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2023 BookMarket. All Rights Reserved.</p>
                </div>
            </div>
        </footer>

        <!-- Notification Container -->
        <div id="notification-container" class="notification-container"></div>

        <!-- JavaScript -->
        <script src="../js/main.js"></script>
        <script src="../js/auth.js"></script>
        <script src="../js/customer-navbar.js"></script>
        <!-- Browse page specific JavaScript -->
        <script>
            // Global variables
            let currentPage = 1;
            let currentFilters = {};
            let totalPages = 1;
            let totalBooks = 0;

            document.addEventListener("DOMContentLoaded", function () {
                console.log("üéØ DOM Content Loaded!");
                // Initialize the page
                initializeBrowsePage();

                // Mobile filter toggle functionality
                const mobileFilterToggle = document.getElementById(
                    "mobile-filter-toggle"
                );
                const filtersContent =
                    document.querySelector("#filters-content");

                if (mobileFilterToggle && filtersContent) {
                    mobileFilterToggle.addEventListener("click", function () {
                        const isVisible =
                            filtersContent.classList.contains("show");
                        if (isVisible) {
                            filtersContent.classList.remove("show");
                            this.innerHTML =
                                '<i class="fas fa-filter"></i> Show Filters';
                        } else {
                            filtersContent.classList.add("show");
                            this.innerHTML =
                                '<i class="fas fa-times"></i> Hide Filters';
                        }
                    });
                }

                // Price range inputs validation
                const minPriceInput = document.getElementById("min-price");
                const maxPriceInput = document.getElementById("max-price");

                if (minPriceInput && maxPriceInput) {
                    minPriceInput.addEventListener("change", function () {
                        if (
                            parseInt(this.value) > parseInt(maxPriceInput.value)
                        ) {
                            this.value = maxPriceInput.value;
                        }
                    });

                    maxPriceInput.addEventListener("change", function () {
                        if (
                            parseInt(this.value) < parseInt(minPriceInput.value)
                        ) {
                            this.value = minPriceInput.value;
                        }
                    });
                }

                // Reset filters button
                const resetFiltersBtn =
                    document.getElementById("reset-filters");
                if (resetFiltersBtn) {
                    resetFiltersBtn.addEventListener("click", function () {
                        document.getElementById("category").selectedIndex = 0;
                        document.getElementById("condition").selectedIndex = 0;
                        document.getElementById("sort-by").selectedIndex = 0;
                        document.getElementById("min-price").value = 0;
                        document.getElementById("max-price").value = 5000;

                        currentFilters = {};
                        currentPage = 1;
                        loadBooks();
                        showNotification("Filters reset successfully!", "info");
                    });
                }

                // Apply filters button
                const applyFiltersBtn =
                    document.getElementById("apply-filters");
                if (applyFiltersBtn) {
                    applyFiltersBtn.addEventListener("click", function () {
                        applyFilters();
                    });
                }

                // Search functionality
                const searchInput = document.querySelector(".search-input");
                const searchButton = document.querySelector(".search-button");

                if (searchInput && searchButton) {
                    // Search on button click
                    searchButton.addEventListener("click", function () {
                        performSearch();
                    });

                    // Search on Enter key
                    searchInput.addEventListener("keypress", function (e) {
                        if (e.key === "Enter") {
                            performSearch();
                        }
                    });
                }

                // View toggle functionality
                const viewToggleButtons = document.querySelectorAll(
                    ".view-toggle button"
                );
                const booksGrid = document.querySelector(".books-grid");

                viewToggleButtons.forEach((button) => {
                    button.addEventListener("click", function () {
                        viewToggleButtons.forEach((btn) =>
                            btn.classList.remove("active")
                        );
                        this.classList.add("active");

                        if (this.innerHTML.includes("fa-th")) {
                            booksGrid.classList.remove("list-view");
                        } else {
                            booksGrid.classList.add("list-view");
                        }
                    });
                });
            });

            // Initialize browse page
            function initializeBrowsePage() {
                console.log("üöÄ Initializing browse page...");
                // Pre-read desired category from query and set initial filter
                const params = new URLSearchParams(window.location.search);
                const desiredRaw = params.get("category");
                if (desiredRaw) {
                    const desired = normalizeCategoryQuery(desiredRaw);
                    if (desired) {
                        currentFilters.category = desired;
                    }
                }

                loadCategories();
                loadConditions();
                loadBooks();
            }

            // Load categories from backend
            function loadCategories() {
                console.log("üìö Loading categories...");
                const form = new FormData();
                form.append("action", "get_categories");

                fetch("../backend/api/browse_books.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        console.log("üìö Categories response:", data);
                        if (data.success && Array.isArray(data.data)) {
                            const categorySelect =
                                document.getElementById("category");
                            categorySelect.innerHTML =
                                '<option value="">All Categories</option>';

                            data.data.forEach((category) => {
                                const option = document.createElement("option");
                                option.value = category.name;
                                option.textContent = category.name;
                                categorySelect.appendChild(option);
                            });
                            console.log("‚úÖ Categories loaded successfully");

                            // After categories are loaded, preselect from URL if present
                            preselectCategoryFromQuery();
                        }
                    })
                    .catch((error) => {
                        console.error("‚ùå Error loading categories:", error);
                    });
            }

            // Map query value to proper category display name
            function normalizeCategoryQuery(value) {
                if (!value) return "";
                const v = decodeURIComponent(value).trim().toLowerCase();
                const map = {
                    fiction: "Fiction",
                    academic: "Academic",
                    science: "Science & Tech",
                    "science-tech": "Science & Tech",
                    science_and_tech: "Science & Tech",
                    business: "Business",
                    children: "Children",
                    history: "History",
                    "self-help": "Self-Help",
                    selfhelp: "Self-Help",
                    cookbooks: "Cookbooks",
                };
                return map[v] || value;
            }

            // Preselect category from URL and apply filters
            function preselectCategoryFromQuery() {
                const params = new URLSearchParams(window.location.search);
                const raw = params.get("category");
                if (!raw) return;

                const wanted = normalizeCategoryQuery(raw);
                const select = document.getElementById("category");
                if (!select) return;

                // Try direct match first
                let matched = false;
                for (let i = 0; i < select.options.length; i++) {
                    const opt = select.options[i];
                    if (
                        opt.value.toLowerCase() === wanted.toLowerCase() ||
                        opt.textContent.toLowerCase() === wanted.toLowerCase()
                    ) {
                        select.selectedIndex = i;
                        matched = true;
                        break;
                    }
                }

                if (matched) {
                    currentFilters.category = select.value;
                    currentPage = 1;
                    loadBooks();
                    showNotification(
                        `Filtered by category: ${select.value}`,
                        "success"
                    );
                } else if (wanted) {
                    // Fallback: apply filter even if option text mismatch
                    currentFilters.category = wanted;
                    currentPage = 1;
                    loadBooks();
                    showNotification(
                        `Filtered by category: ${wanted}`,
                        "success"
                    );
                }
            }

            // Load conditions
            function loadConditions() {
                const form = new FormData();
                form.append("action", "get_conditions");

                fetch("../backend/api/browse_books.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success && Array.isArray(data.data)) {
                            const conditionSelect =
                                document.getElementById("condition");
                            conditionSelect.innerHTML =
                                '<option value="">Any Condition</option>';

                            data.data.forEach((condition) => {
                                const option = document.createElement("option");
                                option.value = condition.value;
                                option.textContent = condition.label;
                                conditionSelect.appendChild(option);
                            });
                        }
                    })
                    .catch((error) => {
                        console.error("Error loading conditions:", error);
                    });
            }

            // Load books with current filters and page
            function loadBooks() {
                console.log("üìñ Loading books...");
                const booksGrid = document.getElementById("books-grid");
                booksGrid.innerHTML =
                    '<div class="loading-placeholder"><p>Loading books...</p></div>';

                const form = new FormData();
                form.append("action", "get_books");
                form.append("page", currentPage);
                form.append("limit", 12);

                // Add filters
                Object.keys(currentFilters).forEach((key) => {
                    if (currentFilters[key]) {
                        form.append(key, currentFilters[key]);
                    }
                });

                console.log("üìñ Fetching books with filters:", currentFilters);

                fetch("../backend/api/browse_books.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        console.log("üìñ Books response:", data);
                        if (data.success && Array.isArray(data.data)) {
                            displayBooks(data.data);
                            updatePagination(data.pagination);
                            updateBooksCount(data.pagination);
                            console.log("‚úÖ Books loaded successfully");
                        } else {
                            console.log("‚ùå No books data in response");
                            displayNoBooks();
                        }
                    })
                    .catch((error) => {
                        console.error("‚ùå Error loading books:", error);
                        displayError();
                    });
            }

            // Display books in the grid
            function displayBooks(books) {
                const booksGrid = document.getElementById("books-grid");
                booksGrid.innerHTML = "";

                if (books.length === 0) {
                    displayNoBooks();
                    return;
                }

                books.forEach((book) => {
                    const bookCard = createBookCard(book);
                    booksGrid.appendChild(bookCard);

                    // Load rating for this book
                    const ratingElement = bookCard.querySelector(
                        `#rating-${book.id}`
                    );
                    if (ratingElement) {
                        loadBookRating(book.id, ratingElement);
                    }
                });
            }

            // Load rating for a specific book
            async function loadBookRating(bookId, ratingElement) {
                try {
                    const response = await fetch(
                        `../backend/api/book_reviews.php?action=get_stats&book_id=${bookId}`
                    );
                    const data = await response.json();

                    const starsElement =
                        ratingElement.querySelector(".rating-stars");
                    const averageElement =
                        ratingElement.querySelector(".rating-average");
                    const countElement =
                        ratingElement.querySelector(".rating-count");

                    if (starsElement && averageElement && countElement) {
                        // Always show rating section
                        ratingElement.style.display = "block";

                        if (data.success && data.stats.total_reviews > 0) {
                            // Display stars with actual rating
                            const rating = Math.round(
                                data.stats.average_rating
                            );
                            const filledStars = "‚òÖ".repeat(rating);
                            const emptyStars = "‚òÜ".repeat(5 - rating);
                            starsElement.innerHTML = filledStars + emptyStars;
                            averageElement.textContent =
                                data.stats.average_rating;
                            countElement.textContent = data.stats.total_reviews;
                        } else {
                            // Display 0 stars for books without reviews
                            starsElement.innerHTML = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
                            averageElement.textContent = "0";
                            countElement.textContent = "0";
                        }
                    }
                } catch (error) {
                    console.error(
                        "Error loading rating for book",
                        bookId,
                        ":",
                        error
                    );

                    // Show 0 stars even if there's an error
                    const starsElement =
                        ratingElement.querySelector(".rating-stars");
                    const averageElement =
                        ratingElement.querySelector(".rating-average");
                    const countElement =
                        ratingElement.querySelector(".rating-count");

                    if (starsElement && averageElement && countElement) {
                        ratingElement.style.display = "block";
                        starsElement.innerHTML = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
                        averageElement.textContent = "0";
                        countElement.textContent = "0";
                    }
                }
            }

            // Create a book card element
            function createBookCard(book) {
                const card = document.createElement("div");
                card.className = "book-card";

                // Handle image path - check multiple sources and provide fallbacks
                let imagePath = "../images/b_cover1.jpg"; // Default fallback

                if (
                    book.cover_image_path &&
                    book.cover_image_path.trim() !== ""
                ) {
                    // If cover_image_path exists and is not empty, use it
                    if (book.cover_image_path.startsWith("uploads/")) {
                        imagePath = `../${book.cover_image_path}`;
                    } else if (
                        book.cover_image_path.startsWith("../uploads/")
                    ) {
                        imagePath = book.cover_image_path;
                    } else if (book.cover_image_path.startsWith("images/")) {
                        // Handle images from the images directory
                        imagePath = `../${book.cover_image_path}`;
                    } else {
                        imagePath = `../uploads/books/${book.cover_image_path}`;
                    }
                } else {
                    // Use a rotating set of default images based on book ID
                    const defaultImages = [
                        "../images/b_cover1.jpg",
                        "../images/b_cover2.jpg",
                        "../images/b_cover3.png",
                        "../images/b_cover4.webp",
                    ];
                    const imageIndex = (book.id - 1) % defaultImages.length;
                    imagePath = defaultImages[imageIndex];
                }

                // Add error handling for images
                const imageHTML = `
                    <div class="book-image">
                        <img src="${imagePath}" 
                             alt="${book.title}" 
                             class="book-cover loading"
                             onerror="this.classList.add('error'); this.nextElementSibling.classList.add('show');"
                             onload="this.classList.remove('loading'); this.nextElementSibling.classList.remove('show');" />
                        <div class="placeholder-image">
                            <i class="fas fa-book"></i>
                            <span>${book.title}</span>
                        </div>
                    </div>
                `;

                card.innerHTML = `
                    ${imageHTML}
                    <div class="book-details">
                        <div class="book-info">
                            <h3>${book.title}</h3>
                            <p class="author">${
                                book.author || "Unknown Author"
                            }</p>
                            
                            <!-- Book Rating Display -->
                            <div class="book-rating" id="rating-${
                                book.id
                            }" style="margin: 0.5rem 0;">
                                <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.3rem;">
                                    <div class="rating-stars" style="color: #f39c12; font-size: 1rem;">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                                    <span style="font-weight: 500; color: var(--dark-color); font-size: 0.9rem;">
                                        <span class="rating-average">0</span>/5
                                    </span>
                                </div>
                                <div style="color: #666; font-size: 0.8rem;">
                                    <span class="rating-count">0</span> reviews
                                </div>
                            </div>
                            
                            <div class="condition">
                                <span>Condition:</span>
                                <span class="condition-badge">${
                                    book.book_condition || "Good"
                                }</span>
                            </div>
                            <p class="price">‡ß≥${book.price || 0}</p>
                        </div>
                        <div class="book-actions">
                            <button class="btn-add-cart" onclick="addToCart(${
                                book.id
                            })">
                                Add to Cart
                            </button>
                            <a href="book-details.html?id=${
                                book.id
                            }" class="btn-view">
                                View Details
                            </a>
                        </div>
                    </div>
                `;

                return card;
            }

            // Display no books message
            function displayNoBooks() {
                const booksGrid = document.getElementById("books-grid");
                booksGrid.innerHTML =
                    '<div class="no-books-message"><p>No books found matching your criteria.</p></div>';
            }

            // Display error message
            function displayError() {
                const booksGrid = document.getElementById("books-grid");
                booksGrid.innerHTML =
                    '<div class="no-books-message"><p>Error loading books. Please try again.</p></div>';
            }

            // Update pagination
            function updatePagination(pagination) {
                const paginationContainer =
                    document.getElementById("pagination");
                if (!paginationContainer) return;

                totalPages = pagination.total_pages;
                totalBooks = pagination.total_books;

                let paginationHTML = "";

                // Previous button
                paginationHTML += `<button class="pagination-button ${
                    pagination.current_page === 1 ? "disabled" : ""
                }" 
                    onclick="goToPage(${pagination.current_page - 1})" ${
                    pagination.current_page === 1 ? "disabled" : ""
                }>
                    <i class="fas fa-chevron-left"></i>
                </button>`;

                // Page numbers
                for (let i = 1; i <= pagination.total_pages; i++) {
                    if (
                        i === 1 ||
                        i === pagination.total_pages ||
                        (i >= pagination.current_page - 2 &&
                            i <= pagination.current_page + 2)
                    ) {
                        paginationHTML += `<button class="pagination-button ${
                            i === pagination.current_page ? "active" : ""
                        }" 
                            onclick="goToPage(${i})">${i}</button>`;
                    } else if (
                        i === pagination.current_page - 3 ||
                        i === pagination.current_page + 3
                    ) {
                        paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                    }
                }

                // Next button
                paginationHTML += `<button class="pagination-button ${
                    pagination.current_page === pagination.total_pages
                        ? "disabled"
                        : ""
                }" 
                    onclick="goToPage(${pagination.current_page + 1})" ${
                    pagination.current_page === pagination.total_pages
                        ? "disabled"
                        : ""
                }>
                    <i class="fas fa-chevron-right"></i>
                </button>`;

                paginationContainer.innerHTML = paginationHTML;
            }

            // Update books count
            function updateBooksCount(pagination) {
                const booksTotal = document.getElementById("books-total");
                if (booksTotal) {
                    booksTotal.textContent = pagination.total_books;
                }
            }

            // Go to specific page
            function goToPage(page) {
                if (page < 1 || page > totalPages) return;
                currentPage = page;
                loadBooks();
            }

            // Apply filters
            function applyFilters() {
                currentFilters = {
                    search: document
                        .querySelector(".search-input")
                        .value.trim(),
                    category: document.getElementById("category").value,
                    condition: document.getElementById("condition").value,
                    min_price: document.getElementById("min-price").value,
                    max_price: document.getElementById("max-price").value,
                    sort_by: document.getElementById("sort-by").value,
                };

                currentPage = 1; // Reset to first page
                loadBooks();
                showNotification("Filters applied successfully!", "success");
            }

            // Perform search
            function performSearch() {
                const searchTerm = document
                    .querySelector(".search-input")
                    .value.trim();
                if (searchTerm) {
                    currentFilters.search = searchTerm;
                    currentPage = 1;
                    loadBooks();
                    showNotification(`Searching for: "${searchTerm}"`, "info");
                }
            }

            // Add to cart function
            function addToCart(bookId) {
                console.log("=== ADD TO CART FUNCTION CALLED ===");
                console.log("addToCart called for bookId:", bookId);
                console.log("window.bookmarketAuth:", window.bookmarketAuth);

                // Check multiple sources for user authentication
                let userId = null;
                let authSource = "";

                // Method 1: Check localStorage bookmarket_user
                const bookmarketUser = localStorage.getItem("bookmarket_user");
                console.log("localStorage bookmarket_user:", bookmarketUser);

                if (bookmarketUser) {
                    try {
                        const userData = JSON.parse(bookmarketUser);
                        console.log("Parsed user data:", userData);

                        if (userData.userId) {
                            userId = userData.userId;
                            authSource = "localStorage bookmarket_user";
                            console.log(
                                "‚úÖ Found userId in localStorage bookmarket_user:",
                                userId
                            );
                        } else if (userData.id) {
                            userId = userData.id;
                            authSource = "localStorage bookmarket_user (id)";
                            console.log(
                                "‚úÖ Found userId in localStorage bookmarket_user (id):",
                                userId
                            );
                        }
                    } catch (e) {
                        console.error(
                            "‚ùå Error parsing localStorage bookmarket_user:",
                            e
                        );
                    }
                }

                // Method 2: Check localStorage user_id directly
                if (!userId) {
                    const directUserId = localStorage.getItem("user_id");
                    console.log("localStorage user_id:", directUserId);
                    if (directUserId) {
                        userId = directUserId;
                        authSource = "localStorage user_id";
                        console.log(
                            "‚úÖ Found userId in localStorage user_id:",
                            userId
                        );
                    }
                }

                // Method 3: Check authentication system
                if (!userId && window.bookmarketAuth) {
                    console.log("Checking window.bookmarketAuth...");
                    console.log(
                        "isLoggedIn():",
                        window.bookmarketAuth.isLoggedIn()
                    );
                    console.log(
                        "getUserId():",
                        window.bookmarketAuth.getUserId()
                    );

                    if (window.bookmarketAuth.isLoggedIn()) {
                        userId = window.bookmarketAuth.getUserId();
                        authSource = "window.bookmarketAuth";
                        console.log(
                            "‚úÖ Found userId in window.bookmarketAuth:",
                            userId
                        );
                    }
                }

                // If still no userId, user is not authenticated
                if (!userId) {
                    console.log("‚ùå No userId found from any source");
                    console.log(
                        "Available localStorage keys:",
                        Object.keys(localStorage)
                    );
                    showNotification(
                        "Please login to add items to cart",
                        "warning"
                    );
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 1500);
                    return;
                }

                console.log(
                    `‚úÖ Authentication successful! Using userId: ${userId} (Source: ${authSource})`
                );

                // Add to cart via API
                const form = new FormData();
                form.append("action", "add_to_cart");
                form.append("user_id", userId);
                form.append("book_id", bookId);
                form.append("quantity", 1);

                fetch("../backend/cart/cart_manager.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            showNotification(data.message, "success");

                            // Update cart count in navbar
                            updateCartCountInNavbar();
                        } else {
                            showNotification(
                                data.message || "Failed to add to cart",
                                "error"
                            );
                        }
                    })
                    .catch((error) => {
                        console.error("Add to cart error:", error);
                        showNotification(
                            "Failed to add to cart. Please try again.",
                            "error"
                        );
                    });
            }

            // Update cart count in navbar
            function updateCartCountInNavbar() {
                // Check multiple sources for user authentication
                let userId = null;

                // Method 1: Check localStorage bookmarket_user
                const bookmarketUser = localStorage.getItem("bookmarket_user");
                if (bookmarketUser) {
                    try {
                        const userData = JSON.parse(bookmarketUser);
                        if (userData.userId) {
                            userId = userData.userId;
                        } else if (userData.id) {
                            userId = userData.id;
                        }
                    } catch (e) {
                        console.error("Error parsing localStorage data:", e);
                    }
                }

                // Method 2: Check localStorage user_id directly
                if (!userId) {
                    const directUserId = localStorage.getItem("user_id");
                    if (directUserId) {
                        userId = directUserId;
                    }
                }

                // Method 3: Check authentication system
                if (
                    !userId &&
                    window.bookmarketAuth &&
                    window.bookmarketAuth.isLoggedIn()
                ) {
                    userId = window.bookmarketAuth.getUserId();
                }

                // If no userId, user is not authenticated
                if (!userId) return;

                const form = new FormData();
                form.append("action", "get_cart_count");
                form.append("user_id", userId);

                fetch("../backend/cart/cart_manager.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success !== false) {
                            const cartCountElements =
                                document.querySelectorAll(".cart-count");
                            cartCountElements.forEach((element) => {
                                element.textContent = data.count || 0;
                            });
                        }
                    })
                    .catch((error) => {
                        console.error("Failed to update cart count:", error);
                    });
            }
        </script>
    </body>
</html>
