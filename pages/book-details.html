<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Book Details - BookMarket</title>
        <link rel="stylesheet" href="../css/styles.css" />
        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <style>
            /* Book Details Page Specific Styles */
            .book-details-container {
                max-width: var(--container-width);
                margin: 2rem auto;
                padding: 0 1rem;
            }

            .book-details-wrapper {
                display: flex;
                gap: 2rem;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                padding: 2rem;
                margin-bottom: 2rem;
            }

            .book-image-gallery {
                flex: 0 0 40%;
            }

            .main-image {
                width: 100%;
                height: 400px;
                background-color: #f0f0f0;
                border-radius: 8px;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            .main-image img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            .thumbnail-images {
                display: flex;
                gap: 0.5rem;
            }

            .thumbnail {
                width: 80px;
                height: 80px;
                background-color: #f0f0f0;
                border-radius: 4px;
                cursor: pointer;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid transparent;
            }

            .thumbnail.active {
                border-color: var(--primary-color);
            }

            .thumbnail img {
                max-width: 100%;
                max-height: 100%;
                object-fit: cover;
            }

            .book-info {
                flex: 1;
            }

            .book-title {
                font-size: 2.5rem;
                color: var(--dark-color);
                margin-bottom: 0.5rem;
            }

            .book-author {
                font-size: 1.2rem;
                color: #666;
                margin-bottom: 1rem;
            }

            .book-category {
                display: inline-block;
                padding: 0.3rem 0.8rem;
                background-color: rgba(74, 111, 165, 0.1);
                color: var(--primary-color);
                border-radius: 50px;
                font-size: 0.9rem;
                font-weight: 600;
                margin-bottom: 1rem;
            }

            .book-price {
                font-size: 2rem;
                font-weight: 700;
                color: var(--primary-color);
                margin-bottom: 1rem;
            }

            .book-condition {
                margin-bottom: 1rem;
            }

            .condition-label {
                font-weight: 600;
                color: var(--dark-color);
                margin-right: 0.5rem;
            }

            .condition-value {
                display: inline-block;
                padding: 0.3rem 0.8rem;
                background-color: rgba(39, 174, 96, 0.1);
                color: var(--success-color);
                border-radius: 50px;
                font-size: 0.9rem;
                font-weight: 600;
            }

            .shipping-info {
                display: flex;
                align-items: center;
                margin-bottom: 1rem;
                color: var(--success-color);
            }

            .shipping-info i {
                margin-right: 0.5rem;
            }

            .stock-info {
                display: flex;
                align-items: center;
                margin-bottom: 1.5rem;
                color: var(--success-color);
            }

            .stock-info i {
                margin-right: 0.5rem;
            }

            .book-actions {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
            }

            .add-to-cart-btn {
                flex: 1;
                padding: 1rem;
                background-color: var(--primary-color);
                color: white;
                border: none;
                border-radius: 4px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .add-to-cart-btn:hover {
                background-color: #3a5a97;
            }

            .add-to-cart-btn i {
                margin-right: 0.5rem;
            }

            .buy-now-btn {
                flex: 1;
                padding: 1rem;
                background-color: var(--secondary-color);
                color: white;
                border: none;
                border-radius: 4px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .buy-now-btn:hover {
                background-color: #d35400;
            }

            .buy-now-btn i {
                margin-right: 0.5rem;
            }

            .seller-info {
                display: flex;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1.5rem;
                border-bottom: 1px solid var(--border-color);
            }

            .seller-avatar {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background-color: #f0f0f0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                color: var(--primary-color);
                margin-right: 1rem;
            }

            .seller-details {
                flex: 1;
            }

            .seller-name {
                font-weight: 600;
                color: var(--dark-color);
                margin-bottom: 0.2rem;
            }

            .seller-email {
                display: flex;
                align-items: center;
                color: #666;
                font-size: 0.9rem;
            }

            .seller-email i {
                color: var(--primary-color);
                margin-right: 0.5rem;
            }

            .book-description {
                margin-bottom: 2rem;
            }

            .description-title {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--dark-color);
                margin-bottom: 1rem;
            }

            .description-content {
                color: #666;
                line-height: 1.6;
            }

            .book-details {
                margin-bottom: 2rem;
            }

            .details-title {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--dark-color);
                margin-bottom: 1rem;
            }

            .details-table {
                width: 100%;
                border-collapse: collapse;
            }

            .details-table tr {
                border-bottom: 1px solid var(--border-color);
            }

            .details-table tr:last-child {
                border-bottom: none;
            }

            .details-table th {
                padding: 0.8rem 0;
                text-align: left;
                font-weight: 600;
                color: var(--dark-color);
                width: 30%;
            }

            .details-table td {
                padding: 0.8rem 0;
                color: #666;
            }

            .section-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: var(--dark-color);
                margin-bottom: 1.5rem;
            }

            /* Reviews: modern star rating */
            .star-rating {
                display: inline-flex;
                align-items: center;
                gap: 0.35rem;
                user-select: none;
            }
            .star-rating .star {
                font-size: 1.25rem;
                color: #c9ced6;
                cursor: pointer;
                transition: transform 0.15s ease, color 0.2s ease;
            }
            .star-rating .star.filled {
                color: #f39c12;
            }
            .star-rating .star:hover {
                transform: scale(1.06);
            }

            /* Responsive styles */
            @media screen and (max-width: 992px) {
                .book-details-wrapper {
                    flex-direction: column;
                }

                .book-image-gallery {
                    flex: none;
                    width: 100%;
                }

                .main-image {
                    height: 300px;
                }
            }

            @media screen and (max-width: 768px) {
                .book-actions {
                    flex-direction: column;
                }
            }

            @media screen and (max-width: 576px) {
                .seller-info {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .seller-avatar {
                    margin-bottom: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-logo">
                    <img
                        src="../images/bookmarket-logo.png"
                        alt="BookMarket"
                        onerror="this.src='https://via.placeholder.com/30x30?text=BM'; this.onerror='';"
                    />
                    <a href="../index.html">BookMarket</a>
                </div>
                <ul class="navbar-menu">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="browse.html">Browse Books</a></li>
                    <li><a href="sell.html">Sell</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
                <div class="navbar-buttons">
                    <div class="auth-buttons">
                        <a href="login.html" class="btn-login">Login</a>
                        <a href="signup.html" class="btn-signup">Sign Up</a>
                    </div>
                    <a href="#" class="cart-icon"
                        ><i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">0</span></a
                    >
                </div>
                <div class="navbar-toggle">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
        </nav>

        <!-- Notification Container -->
        <div id="notification-container"></div>

        <!-- Book Details Content -->
        <div class="book-details-container">
            <div class="book-details-wrapper">
                <!-- Book Image Gallery -->
                <div class="book-image-gallery">
                    <div class="main-image">
                        <img
                            src="../images/b_cover1.jpg"
                            alt="Book Cover"
                            id="main-book-image"
                        />
                    </div>
                    <div class="thumbnail-images" id="thumbnail-images">
                        <!-- Thumbnails will be loaded dynamically -->
                    </div>
                </div>

                <!-- Book Information -->
                <div class="book-info">
                    <h1 class="book-title" id="book-title">Loading...</h1>
                    <p class="book-author" id="book-author">Loading...</p>

                    <div class="book-category" id="book-category">
                        Loading...
                    </div>

                    <div class="book-price" id="book-price">Loading...</div>

                    <!-- Book Rating Display -->
                    <div
                        class="book-rating-display"
                        id="book-rating-display"
                        style="margin: 1rem 0"
                    >
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                                margin-bottom: 0.5rem;
                            "
                        >
                            <div
                                class="rating-stars"
                                id="rating-stars-display"
                                style="color: #f39c12; font-size: 1.2rem"
                            >
                                ☆☆☆☆☆
                            </div>
                            <span
                                style="
                                    font-weight: 600;
                                    color: var(--dark-color);
                                "
                            >
                                <span id="rating-average">0</span>/5
                            </span>
                        </div>
                        <div style="color: #666; font-size: 0.9rem">
                            <span id="rating-count">0</span> reviews
                        </div>
                    </div>

                    <div class="book-condition">
                        <span class="condition-label">Condition:</span>
                        <span class="condition-value" id="book-condition"
                            >Loading...</span
                        >
                    </div>

                    <div class="stock-info">
                        <i class="fas fa-check-circle"></i> Available Items:
                        <span id="stock-count">Loading...</span>
                    </div>

                    <div class="book-actions">
                        <button class="add-to-cart-btn">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                        <button class="buy-now-btn">
                            <i class="fas fa-bolt"></i> Buy Now
                        </button>
                    </div>

                    <div class="seller-info">
                        <div class="seller-avatar" id="seller-avatar">--</div>
                        <div class="seller-details">
                            <div class="seller-name" id="seller-name">
                                Loading...
                            </div>
                            <div class="seller-email">
                                <i class="fas fa-envelope"></i>
                                <span id="seller-email">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="book-description">
                        <h3 class="description-title">About This Book</h3>
                        <div class="description-content">
                            <p id="book-description">Loading...</p>
                        </div>
                    </div>

                    <div class="book-details">
                        <h3 class="details-title">Book Details</h3>
                        <table class="details-table">
                            <tr>
                                <th>ISBN</th>
                                <td id="book-isbn">Loading...</td>
                            </tr>
                            <tr>
                                <th>Category</th>
                                <td id="book-category-detail">Loading...</td>
                            </tr>
                            <tr>
                                <th>Condition</th>
                                <td id="book-condition-detail">Loading...</td>
                            </tr>
                            <tr>
                                <th>Added Date</th>
                                <td id="book-added-date">Loading...</td>
                            </tr>
                            <tr>
                                <th>Seller</th>
                                <td id="book-seller-detail">Loading...</td>
                            </tr>
                            <tr>
                                <th>Contact Email</th>
                                <td id="book-seller-email">Loading...</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Reviews -->
        <div class="book-details-container" id="reviews-section">
            <div
                class="section-card"
                style="
                    background: #fff;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
                    padding: 1.5rem;
                    margin-bottom: 2rem;
                "
            >
                <h3 class="section-title" style="margin-top: 0">
                    Customer Reviews
                </h3>

                <!-- Review Statistics -->
                <div
                    id="review-stats"
                    style="
                        margin-bottom: 1.5rem;
                        padding: 1rem;
                        background: #f8f9fa;
                        border-radius: 6px;
                        display: none;
                    "
                >
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            flex-wrap: wrap;
                        "
                    >
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            "
                        >
                            <span style="font-size: 1.5rem; color: #f39c12"
                                >★</span
                            >
                            <span
                                style="
                                    font-weight: 600;
                                    color: var(--dark-color);
                                "
                            >
                                <span id="avg-rating">0</span>/5
                            </span>
                        </div>
                        <span style="color: #666">•</span>
                        <span style="color: #666">
                            <span id="total-reviews">0</span> reviews
                        </span>
                    </div>
                </div>
                <!-- Review Form -->
                <div
                    id="review-form-wrapper"
                    style="
                        margin-bottom: 1.5rem;
                        border-bottom: 1px solid var(--border-color);
                        padding-bottom: 1.5rem;
                    "
                >
                    <div
                        id="review-login-hint"
                        style="
                            display: none;
                            color: #666;
                            margin-bottom: 0.75rem;
                        "
                    >
                        Please login to write a review.
                    </div>
                    <form
                        id="review-form"
                        style="
                            display: flex;
                            flex-direction: column;
                            gap: 0.75rem;
                        "
                    >
                        <div
                            style="
                                display: flex;
                                gap: 0.75rem;
                                align-items: center;
                            "
                        >
                            <label
                                style="
                                    font-weight: 600;
                                    color: var(--dark-color);
                                "
                                >Rating</label
                            >
                            <div
                                class="star-rating"
                                id="star-rating"
                                aria-label="Choose rating from 1 to 5"
                            >
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <input type="hidden" id="review-rating" value="5" />
                        </div>
                        <textarea
                            id="review-text"
                            rows="4"
                            placeholder="Write your review..."
                            style="
                                padding: 0.8rem;
                                border: 1px solid var(--border-color);
                                border-radius: 4px;
                                resize: vertical;
                            "
                        ></textarea>
                        <div
                            style="
                                display: flex;
                                gap: 0.75rem;
                                justify-content: flex-end;
                            "
                        >
                            <button
                                type="submit"
                                class="btn btn-primary"
                                id="submit-review-btn"
                                style="min-width: 160px"
                            >
                                Submit Review
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Reviews List -->
                <div id="reviews-list">
                    <div class="empty-state">
                        <i class="fas fa-comment-dots"></i>
                        <h3>No reviews yet</h3>
                        <p>Be the first to write a review for this book.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-top">
                    <div class="footer-column">
                        <h3>BookMarket</h3>
                        <p>
                            Your one-stop destination for buying and selling
                            books online. Find your next favorite book or give
                            your old books a new home.
                        </p>
                        <div class="social-links">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        </div>
                    </div>
                    <div class="footer-column">
                        <h3>Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="../index.html">Home</a></li>
                            <li><a href="browse.html">Browse Books</a></li>
                            <li><a href="sell.html">Sell Books</a></li>
                            <li><a href="about.html">About Us</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul class="footer-links">
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">FAQs</a></li>
                            <li><a href="#">Shipping Policy</a></li>
                            <li><a href="#">Return Policy</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Contact</h3>
                        <ul class="contact-info">
                            <li>
                                <i class="fas fa-map-marker-alt"></i> 123 Book
                                Street, Dhaka, Bangladesh
                            </li>
                            <li>
                                <i class="fas fa-phone"></i> +880 123 456789
                            </li>
                            <li>
                                <i class="fas fa-envelope"></i>
                                support@bookmarket.com
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2023 BookMarket. All Rights Reserved.</p>
                </div>
            </div>
        </footer>

        <!-- JavaScript -->
        <script src="../js/main.js"></script>
        <script src="../js/auth.js"></script>
        <script src="../js/customer-navbar.js"></script>
        <!-- Book Details Specific JavaScript -->
        <script>
            // Simple test to confirm script is loading
            console.log("🚀 Book Details Script Loaded!");

            // Global variables
            let currentBookId = null;
            let bookData = null;

            // Simple initialization - no complex waiting logic
            document.addEventListener("DOMContentLoaded", function () {
                console.log("🎯 Book Details Page Loaded!");
                initializeBookDetailsPage();
            });

            // Fallback initialization
            if (document.readyState !== "loading") {
                console.log(
                    "📖 DOM already loaded, initializing immediately..."
                );
                initializeBookDetailsPage();
            }

            // Initialize book details page
            function initializeBookDetailsPage() {
                console.log("🚀 Initializing book details page...");

                // Test basic DOM manipulation

                const testElement = document.getElementById("book-title");
                if (testElement) {
                    testElement.textContent = "TEST: DOM is working!";
                } else {
                    console.error(
                        "❌ DOM manipulation test failed - book-title element not found"
                    );
                }

                // Get book ID from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                currentBookId = urlParams.get("id");

                if (!currentBookId) {
                    console.error("❌ No book ID found in URL");
                    try {
                        showNotification("No book ID provided", "error");
                    } catch (e) {
                        console.error("❌ showNotification failed:", e);
                    }
                    return;
                }

                console.log("📖 Loading book details for ID:", currentBookId);

                // Load book details
                loadBookDetails(currentBookId);

                // Initialize UI elements
                initializeUI();
            }

            // Initialize UI elements
            function initializeUI() {
                // Initialize cart count
                initializeCartCount();

                // Image gallery functionality
                const mainImage = document.getElementById("main-book-image");
                const thumbnails = document.querySelectorAll(".thumbnail");

                // Add to cart button
                const addToCartBtn = document.querySelector(".add-to-cart-btn");
                if (addToCartBtn) {
                    addToCartBtn.addEventListener("click", function () {
                        // Check if user is logged in
                        if (!isLoggedIn()) {
                            try {
                                showNotification(
                                    "Please login to add items to cart",
                                    "warning"
                                );
                            } catch (e) {
                                console.error("❌ showNotification failed:", e);
                            }
                            // Redirect to login page
                            setTimeout(() => {
                                window.location.href = "login.html";
                            }, 1500);
                            return;
                        }

                        // Add to cart functionality
                        addToCart(currentBookId);
                    });
                }

                // Buy now button
                const buyNowBtn = document.querySelector(".buy-now-btn");
                if (buyNowBtn) {
                    buyNowBtn.addEventListener("click", function () {
                        // Check if user is logged in
                        if (!isLoggedIn()) {
                            try {
                                showNotification(
                                    "Please login to purchase books",
                                    "warning"
                                );
                            } catch (e) {
                                console.error("❌ showNotification failed:", e);
                            }
                            // Redirect to login page
                            setTimeout(() => {
                                window.location.href = "login.html";
                            }, 1500);
                            return;
                        }

                        try {
                            showNotification("Proceeding to checkout!", "info");
                            // Redirect to payment page with book details
                            setTimeout(() => {
                                const paymentUrl = `payment.html?book_id=${currentBookId}&action=buy_now`;
                                window.location.href = paymentUrl;
                            }, 1000);
                        } catch (e) {
                            console.error("❌ showNotification failed:", e);
                        }
                    });
                }
            }

            // Load book details from backend
            function loadBookDetails(bookId) {
                console.log("📖 Fetching book details for ID:", bookId);
                console.log("🔗 API URL:", "../backend/api/book_details.php");

                const form = new FormData();
                form.append("action", "get_book_details");
                form.append("book_id", bookId);

                console.log("📤 Form data:", {
                    action: "get_book_details",
                    book_id: bookId,
                });

                fetch("../backend/api/book_details.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => {
                        console.log("📡 Response status:", response.status);
                        console.log("📡 Response headers:", response.headers);

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`
                            );
                        }

                        return response.json();
                    })
                    .then((data) => {
                        console.log("📖 Book details response:", data);

                        if (data.success) {
                            console.log("✅ Data received successfully");
                            bookData = data.data;
                            console.log("📚 Book data:", bookData);

                            displayBookDetails(bookData);
                            // Load reviews from database
                            loadReviewsFromDatabase();
                        } else {
                            console.error(
                                "❌ API returned error:",
                                data.message
                            );

                            try {
                                showNotification(
                                    data.message ||
                                        "Failed to load book details",
                                    "error"
                                );
                            } catch (e) {
                                console.error("❌ showNotification failed:", e);
                            }
                            displayError();
                        }
                    })
                    .catch((error) => {
                        console.error("❌ Error loading book details:", error);

                        try {
                            showNotification(
                                "Failed to load book details",
                                "error"
                            );
                        } catch (e) {
                            console.error("❌ showNotification failed:", e);
                        }
                        displayError();
                    });
            }

            // Display book details in the UI
            function displayBookDetails(data) {
                console.log("🎨 Starting to display book details...");
                const book = data.book;
                console.log("📖 Book object:", book);

                // Update page title
                document.title = `${book.title} - BookMarket`;
                console.log("📝 Page title updated");

                // Update main book image
                const mainImage = document.getElementById("main-book-image");
                console.log("🖼️ Main image element:", mainImage);
                if (book.cover_image_path) {
                    mainImage.src = `../${book.cover_image_path}`;
                    mainImage.alt = book.title;
                    console.log(
                        "🖼️ Main image updated with:",
                        `../${book.cover_image_path}`
                    );
                } else {
                    console.log("🖼️ No cover image path, using default");
                }

                // Update book information
                console.log("📚 Updating book information elements...");

                const titleElement = document.getElementById("book-title");
                console.log("📚 Title element:", titleElement);
                if (titleElement) {
                    titleElement.textContent = book.title;
                    console.log("✅ Title updated to:", book.title);
                } else {
                    console.error("❌ Title element not found!");
                }

                const authorElement = document.getElementById("book-author");
                console.log("📚 Author element:", authorElement);
                if (authorElement) {
                    authorElement.textContent = `by ${book.author}`;
                    console.log("✅ Author updated to:", `by ${book.author}`);
                } else {
                    console.error("❌ Author element not found!");
                }

                const categoryElement =
                    document.getElementById("book-category");
                console.log("📚 Category element:", categoryElement);
                if (categoryElement) {
                    categoryElement.textContent = book.category_name;
                    console.log("✅ Category updated to:", book.category_name);
                } else {
                    console.error("❌ Category element not found!");
                }

                const priceElement = document.getElementById("book-price");
                console.log("📚 Price element:", priceElement);
                if (priceElement) {
                    priceElement.textContent = `৳${book.price}`;
                    console.log("✅ Price updated to:", `৳${book.price}`);
                } else {
                    console.error("❌ Price element not found!");
                }

                const conditionElement =
                    document.getElementById("book-condition");
                console.log("📚 Condition element:", conditionElement);
                if (conditionElement) {
                    conditionElement.textContent = book.book_condition;
                    console.log(
                        "✅ Condition updated to:",
                        book.book_condition
                    );
                } else {
                    console.error("❌ Condition element not found!");
                }

                const descriptionElement =
                    document.getElementById("book-description");
                console.log("📚 Description element:", descriptionElement);
                if (descriptionElement) {
                    descriptionElement.textContent =
                        book.description || "No description available.";
                    console.log("✅ Description updated");
                } else {
                    console.error("❌ Description element not found!");
                }

                console.log("📋 Updating book details table...");

                // Update book details table
                const isbnElement = document.getElementById("book-isbn");
                if (isbnElement) {
                    isbnElement.textContent = book.isbn || "N/A";
                    console.log("✅ ISBN updated to:", book.isbn || "N/A");
                }

                const categoryDetailElement = document.getElementById(
                    "book-category-detail"
                );
                if (categoryDetailElement) {
                    categoryDetailElement.textContent = book.category_name;
                    console.log(
                        "✅ Category detail updated to:",
                        book.category_name
                    );
                }

                const conditionDetailElement = document.getElementById(
                    "book-condition-detail"
                );
                if (conditionDetailElement) {
                    conditionDetailElement.textContent = book.book_condition;
                    console.log(
                        "✅ Condition detail updated to:",
                        book.book_condition
                    );
                }

                const addedDateElement =
                    document.getElementById("book-added-date");
                if (addedDateElement) {
                    addedDateElement.textContent = formatDate(book.created_at);
                    console.log(
                        "✅ Added date updated to:",
                        formatDate(book.created_at)
                    );
                }

                const sellerDetailElement =
                    document.getElementById("book-seller-detail");
                if (sellerDetailElement) {
                    sellerDetailElement.textContent = book.seller_name;
                    console.log(
                        "✅ Seller detail updated to:",
                        book.seller_name
                    );
                }

                console.log("👤 Updating seller information...");

                // Update seller information
                const sellerNameElement =
                    document.getElementById("seller-name");
                if (sellerNameElement) {
                    sellerNameElement.textContent = book.seller_name;
                    console.log("✅ Seller name updated to:", book.seller_name);
                }

                const sellerAvatarElement =
                    document.getElementById("seller-avatar");
                if (sellerAvatarElement) {
                    sellerAvatarElement.textContent = getInitials(
                        book.seller_name
                    );
                    console.log(
                        "✅ Seller avatar updated to:",
                        getInitials(book.seller_name)
                    );
                }

                // Update seller email
                const sellerEmailElement =
                    document.getElementById("seller-email");
                if (sellerEmailElement) {
                    sellerEmailElement.textContent = book.seller_email || "N/A";
                    console.log(
                        "✅ Seller email updated to:",
                        book.seller_email || "N/A"
                    );
                }

                // Update seller email in details table
                const sellerEmailDetailElement =
                    document.getElementById("book-seller-email");
                if (sellerEmailDetailElement) {
                    sellerEmailDetailElement.textContent =
                        book.seller_email || "N/A";
                    console.log(
                        "✅ Seller email detail updated to:",
                        book.seller_email || "N/A"
                    );
                }

                // Update stock count
                const stockCountElement =
                    document.getElementById("stock-count");
                if (stockCountElement) {
                    stockCountElement.textContent = book.stock_quantity || 0;
                    console.log(
                        "✅ Stock count updated to:",
                        book.stock_quantity || 0
                    );
                }

                // Update thumbnails
                updateThumbnails(book);
                console.log("🖼️ Thumbnails updated");

                console.log("✅ Book details displayed successfully");
            }

            // Load reviews from database
            async function loadReviewsFromDatabase() {
                try {
                    const bookId = new URLSearchParams(
                        window.location.search
                    ).get("id");
                    if (!bookId) return;

                    // Load reviews
                    const reviewsResponse = await fetch(
                        `../backend/api/book_reviews.php?action=get_reviews&book_id=${bookId}`
                    );
                    const reviewsData = await reviewsResponse.json();

                    if (reviewsData.success) {
                        displayReviews(reviewsData.reviews || []);
                    } else {
                        console.error(
                            "Failed to load reviews:",
                            reviewsData.message
                        );
                        handleReviewsError();
                    }

                    // Load review statistics
                    const statsResponse = await fetch(
                        `../backend/api/book_reviews.php?action=get_stats&book_id=${bookId}`
                    );
                    const statsData = await statsResponse.json();

                    if (statsData.success) {
                        displayReviewStats(statsData.stats);
                    } else {
                        console.error(
                            "Failed to load review stats:",
                            statsData.message
                        );
                    }
                } catch (error) {
                    console.error("Error loading reviews:", error);
                    handleReviewsError();
                }
            }

            // Display review statistics
            function displayReviewStats(stats) {
                const statsContainer = document.getElementById("review-stats");
                const avgRating = document.getElementById("avg-rating");
                const totalReviews = document.getElementById("total-reviews");

                if (statsContainer && avgRating && totalReviews) {
                    if (stats.total_reviews > 0) {
                        avgRating.textContent = stats.average_rating;
                        totalReviews.textContent = stats.total_reviews;
                        statsContainer.style.display = "block";
                    } else {
                        statsContainer.style.display = "none";
                    }
                }

                // Also update the main book rating display
                displayBookRating(stats);
            }

            // Display book rating in the main book info section
            function displayBookRating(stats) {
                const ratingDisplay = document.getElementById(
                    "book-rating-display"
                );
                const ratingStars = document.getElementById(
                    "rating-stars-display"
                );
                const ratingAverage = document.getElementById("rating-average");
                const ratingCount = document.getElementById("rating-count");

                if (
                    ratingDisplay &&
                    ratingStars &&
                    ratingAverage &&
                    ratingCount
                ) {
                    // Always show rating section
                    ratingDisplay.style.display = "block";

                    if (stats.total_reviews > 0) {
                        // Display stars with actual rating
                        const rating = Math.round(stats.average_rating);
                        const filledStars = "★".repeat(rating);
                        const emptyStars = "☆".repeat(5 - rating);
                        ratingStars.innerHTML = filledStars + emptyStars;

                        // Display average and count
                        ratingAverage.textContent = stats.average_rating;
                        ratingCount.textContent = stats.total_reviews;
                    } else {
                        // Display 0 stars for books without reviews
                        ratingStars.innerHTML = "☆☆☆☆☆";
                        ratingAverage.textContent = "0";
                        ratingCount.textContent = "0";
                    }
                }
            }

            // Add error handling for when reviews fail to load
            function handleReviewsError() {
                const list = document.getElementById("reviews-list");
                if (list) {
                    list.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #f39c12; margin-bottom: 1rem;"></i>
                            <h3>Unable to load reviews</h3>
                            <p>There was an error loading reviews. Please try refreshing the page.</p>
                        </div>`;
                }
            }

            // Display reviews
            function displayReviews(reviews) {
                const list = document.getElementById("reviews-list");
                if (!list) return;

                // Normalize reviews
                const items = Array.isArray(reviews) ? reviews : [];

                if (!items.length) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment-dots"></i>
                            <h3>No reviews yet</h3>
                            <p>Be the first to write a review for this book.</p>
                        </div>`;
                    return;
                }

                // Render reviews
                list.innerHTML = items
                    .map((r) => {
                        const rating = Math.max(
                            1,
                            Math.min(5, parseInt(r.rating || 0))
                        );
                        const stars = "★★★★★☆☆☆☆☆".slice(
                            5 - rating,
                            10 - rating
                        );
                        return `
                        <div class="review-item" style="display:flex; gap:0.75rem; padding:1rem 0; border-bottom:1px solid var(--border-color);">
                            <div class="review-avatar" style="width:40px; height:40px; border-radius:50%; background:#f0f2f5; display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--primary-color);">${(
                                r.author || "U"
                            )
                                .toString()
                                .charAt(0)
                                .toUpperCase()}</div>
                            <div class="review-body" style="flex:1;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                    <strong style="color:var(--dark-color);">${
                                        r.author || "Anonymous"
                                    }</strong>
                                    <span style="font-size:0.85rem; color:#888;">${formatDate(
                                        r.created_at || new Date()
                                    )}</span>
                                </div>
                                <div class="review-rating" aria-label="${rating} out of 5" style="color:#f39c12; margin-bottom:0.35rem;">${"★".repeat(
                            rating
                        )}${"☆".repeat(5 - rating)}</div>
                                <div class="review-text" style="color:#444;">${(
                                    r.review_text || ""
                                )
                                    .toString()
                                    .replace(/</g, "&lt;")}</div>
                            </div>
                        </div>`;
                    })
                    .join("");
            }

            // Submit review (frontend only demo; wire to backend later)
            document.addEventListener("DOMContentLoaded", () => {
                const form = document.getElementById("review-form");
                const text = document.getElementById("review-text");
                const rating = document.getElementById("review-rating");
                const loginHint = document.getElementById("review-login-hint");
                const submitBtn = document.getElementById("submit-review-btn");
                const starContainer = document.getElementById("star-rating");

                const isUserLoggedIn = () => {
                    try {
                        const u = JSON.parse(
                            localStorage.getItem("bookmarket_user") || "{}"
                        );
                        return !!u.userId;
                    } catch (_) {
                        return false;
                    }
                };

                const updateFormState = () => {
                    const loggedIn = isUserLoggedIn();
                    if (loginHint)
                        loginHint.style.display = loggedIn ? "none" : "block";
                    if (text) text.disabled = !loggedIn;
                    if (rating) rating.disabled = !loggedIn;
                    if (submitBtn) submitBtn.disabled = !loggedIn;
                };

                updateFormState();

                // Interactive star rating behavior
                if (starContainer && rating) {
                    const stars = Array.from(
                        starContainer.querySelectorAll(".star")
                    );
                    const setStars = (val) => {
                        stars.forEach((s) => {
                            const v = parseInt(s.getAttribute("data-value"));
                            s.classList.toggle("filled", v <= val);
                        });
                    };
                    // initialize default
                    setStars(parseInt(rating.value || 5));
                    stars.forEach((star) => {
                        star.addEventListener("mouseenter", () => {
                            if (submitBtn && submitBtn.disabled) return;
                            setStars(parseInt(star.getAttribute("data-value")));
                        });
                        star.addEventListener("click", () => {
                            if (submitBtn && submitBtn.disabled) return;
                            const val = parseInt(
                                star.getAttribute("data-value")
                            );
                            rating.value = String(val);
                            setStars(val);
                        });
                    });
                    starContainer.addEventListener("mouseleave", () => {
                        setStars(parseInt(rating.value || 5));
                    });
                }

                if (form) {
                    form.addEventListener("submit", async (e) => {
                        e.preventDefault();
                        if (!isUserLoggedIn()) return;

                        const bookId = new URLSearchParams(
                            window.location.search
                        ).get("id");
                        const ratingValue = parseInt(rating.value || 5);
                        const commentText = text.value.trim();

                        if (!commentText) {
                            try {
                                showNotification(
                                    "Please write something in your review",
                                    "warning"
                                );
                            } catch (_) {}
                            return;
                        }

                        try {
                            // Submit review to backend
                            const response = await fetch(
                                "../backend/api/book_reviews.php?action=create_review",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        book_id: bookId,
                                        rating: ratingValue,
                                        comment: commentText,
                                    }),
                                }
                            );

                            const data = await response.json();

                            if (data.success) {
                                // Clear form
                                text.value = "";
                                rating.value = "5";

                                // Reset stars to default
                                if (starContainer) {
                                    const stars = Array.from(
                                        starContainer.querySelectorAll(".star")
                                    );
                                    stars.forEach((s, index) => {
                                        s.classList.toggle("filled", index < 5);
                                    });
                                }

                                // Reload reviews from database
                                await loadReviewsFromDatabase();

                                try {
                                    showNotification(
                                        "Review submitted successfully!",
                                        "success"
                                    );
                                } catch (_) {}
                            } else {
                                try {
                                    showNotification(
                                        data.message ||
                                            "Failed to submit review",
                                        "error"
                                    );
                                } catch (_) {}
                            }
                        } catch (error) {
                            console.error("Error submitting review:", error);
                            try {
                                showNotification(
                                    "Failed to submit review. Please try again.",
                                    "error"
                                );
                            } catch (_) {}
                        }
                    });
                }
            });

            // Update thumbnails
            function updateThumbnails(book) {
                const thumbnailsContainer =
                    document.getElementById("thumbnail-images");

                // Clear existing thumbnails
                thumbnailsContainer.innerHTML = "";

                // Add main image as first thumbnail
                const mainThumbnail = document.createElement("div");
                mainThumbnail.className = "thumbnail active";
                mainThumbnail.setAttribute(
                    "data-image",
                    book.cover_image_path
                        ? `../${book.cover_image_path}`
                        : "../images/b_cover1.jpg"
                );

                const mainThumbImg = document.createElement("img");
                mainThumbImg.src = book.cover_image_path
                    ? `../${book.cover_image_path}`
                    : "../images/b_cover1.jpg";
                mainThumbImg.alt = `${book.title} - Main Image`;

                mainThumbnail.appendChild(mainThumbImg);
                thumbnailsContainer.appendChild(mainThumbnail);

                // Add additional images if available
                if (book.additional_images) {
                    try {
                        const additionalImages = JSON.parse(
                            book.additional_images
                        );
                        additionalImages.forEach((imagePath, index) => {
                            const thumbnail = document.createElement("div");
                            thumbnail.className = "thumbnail";
                            thumbnail.setAttribute(
                                "data-image",
                                `../${imagePath}`
                            );

                            const img = document.createElement("img");
                            img.src = `../${imagePath}`;
                            img.alt = `${book.title} - Image ${index + 2}`;

                            thumbnail.appendChild(img);
                            thumbnailsContainer.appendChild(thumbnail);
                        });
                    } catch (e) {
                        console.log("No additional images to display");
                    }
                }

                // Add click event listeners to thumbnails
                const thumbnails =
                    thumbnailsContainer.querySelectorAll(".thumbnail");
                thumbnails.forEach((thumbnail) => {
                    thumbnail.addEventListener("click", function () {
                        const mainImage =
                            document.getElementById("main-book-image");
                        mainImage.src = this.getAttribute("data-image");

                        thumbnails.forEach((thumb) =>
                            thumb.classList.remove("active")
                        );
                        this.classList.add("active");
                    });
                });
            }

            // Format date
            function formatDate(dateString) {
                if (!dateString) return "N/A";

                const date = new Date(dateString);
                return date.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                });
            }

            // Get initials from name
            function getInitials(name) {
                if (!name) return "--";
                return name
                    .split(" ")
                    .map((word) => word.charAt(0))
                    .join("")
                    .toUpperCase()
                    .substring(0, 2);
            }

            // Display error state
            function displayError() {
                document.getElementById("book-title").textContent =
                    "Book Not Found";
                document.getElementById("book-author").textContent =
                    "Unable to load book details";
                document.getElementById("book-description").textContent =
                    "The requested book could not be found or is no longer available.";
            }

            // Add to cart functionality
            function addToCart(bookId) {
                // Check if user is logged in
                const user = JSON.parse(
                    localStorage.getItem("bookmarket_user") || "{}"
                );
                if (!user.userId) {
                    try {
                        showNotification(
                            "Please login to add items to cart",
                            "warning"
                        );
                    } catch (e) {
                        console.error("❌ showNotification failed:", e);
                    }
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 1500);
                    return;
                }

                if (!bookData || !bookData.book) {
                    try {
                        showNotification("Book data not available", "error");
                    } catch (e) {
                        console.error("❌ showNotification failed:", e);
                    }
                    return;
                }

                // Add to cart via API
                const form = new FormData();
                form.append("action", "add_to_cart");
                form.append("user_id", user.userId);
                form.append("book_id", bookId);
                form.append("quantity", 1);

                fetch("../backend/cart/cart_manager.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            try {
                                showNotification(data.message, "success");
                            } catch (e) {
                                console.error("❌ showNotification failed:", e);
                            }

                            // Update cart count in navbar
                            updateCartCountFromDatabase();

                            // Redirect to cart page after successful addition
                            setTimeout(() => {
                                window.location.href = "cart.html";
                            }, 1500);
                        } else {
                            try {
                                showNotification(
                                    data.message || "Failed to add to cart",
                                    "error"
                                );
                            } catch (e) {
                                console.error("❌ showNotification failed:", e);
                            }
                        }
                    })
                    .catch((error) => {
                        console.error("Add to cart error:", error);
                        try {
                            showNotification(
                                "Failed to add to cart. Please try again.",
                                "error"
                            );
                        } catch (e) {
                            console.error("❌ showNotification failed:", e);
                        }
                    });
            }

            // Update cart count from database
            function updateCartCountFromDatabase() {
                const user = JSON.parse(
                    localStorage.getItem("bookmarket_user") || "{}"
                );
                if (!user.userId) return;

                const form = new FormData();
                form.append("action", "get_cart_count");
                form.append("user_id", user.userId);

                fetch("../backend/cart/cart_manager.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success !== false) {
                            const cartCountElements =
                                document.querySelectorAll(".cart-count");
                            cartCountElements.forEach((element) => {
                                element.textContent = data.count || 0;
                            });
                        }
                    })
                    .catch((error) => {
                        console.error("Failed to update cart count:", error);
                        console.error("Failed to update cart count:", error);
                    });
            }

            // Check if user is logged in (helper function)
            function isLoggedIn() {
                return localStorage.getItem("bookmarket_user") !== null;
            }

            // Get user type (helper function)
            function getUserType() {
                const user = localStorage.getItem("bookmarket_user");
                return user ? JSON.parse(user).userType : null;
            }

            // Initialize cart count from database
            function initializeCartCount() {
                updateCartCountFromDatabase();
            }
        </script>
    </body>
</html>
