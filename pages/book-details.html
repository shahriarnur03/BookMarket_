<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Book Details - BookMarket</title>
        <link rel="stylesheet" href="../css/styles.css" />
        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <style>
            /* Book Details Page Specific Styles */
            .book-details-container {
                max-width: var(--container-width);
                margin: 2rem auto;
                padding: 0 1rem;
            }

            .book-details-wrapper {
                display: flex;
                gap: 2rem;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                padding: 2rem;
                margin-bottom: 2rem;
            }

            .book-image-gallery {
                flex: 0 0 40%;
            }

            .main-image {
                width: 100%;
                height: 400px;
                background-color: #f0f0f0;
                border-radius: 8px;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            .main-image img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            .thumbnail-images {
                display: flex;
                gap: 0.5rem;
            }

            .thumbnail {
                width: 80px;
                height: 80px;
                background-color: #f0f0f0;
                border-radius: 4px;
                cursor: pointer;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid transparent;
            }

            .thumbnail.active {
                border-color: var(--primary-color);
            }

            .thumbnail img {
                max-width: 100%;
                max-height: 100%;
                object-fit: cover;
            }

            .book-info {
                flex: 1;
            }

            .book-title {
                font-size: 2.5rem;
                color: var(--dark-color);
                margin-bottom: 0.5rem;
            }

            .book-author {
                font-size: 1.2rem;
                color: #666;
                margin-bottom: 1rem;
            }

            .book-category {
                display: inline-block;
                padding: 0.3rem 0.8rem;
                background-color: rgba(74, 111, 165, 0.1);
                color: var(--primary-color);
                border-radius: 50px;
                font-size: 0.9rem;
                font-weight: 600;
                margin-bottom: 1rem;
            }

            .book-price {
                font-size: 2rem;
                font-weight: 700;
                color: var(--primary-color);
                margin-bottom: 1rem;
            }

            .book-condition {
                margin-bottom: 1rem;
            }

            .condition-label {
                font-weight: 600;
                color: var(--dark-color);
                margin-right: 0.5rem;
            }

            .condition-value {
                display: inline-block;
                padding: 0.3rem 0.8rem;
                background-color: rgba(39, 174, 96, 0.1);
                color: var(--success-color);
                border-radius: 50px;
                font-size: 0.9rem;
                font-weight: 600;
            }

            .shipping-info {
                display: flex;
                align-items: center;
                margin-bottom: 1rem;
                color: var(--success-color);
            }

            .shipping-info i {
                margin-right: 0.5rem;
            }

            .stock-info {
                display: flex;
                align-items: center;
                margin-bottom: 1.5rem;
                color: var(--success-color);
            }

            .stock-info i {
                margin-right: 0.5rem;
            }

            .book-actions {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
            }

            .add-to-cart-btn {
                flex: 1;
                padding: 1rem;
                background-color: var(--primary-color);
                color: white;
                border: none;
                border-radius: 4px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .add-to-cart-btn:hover {
                background-color: #3a5a97;
            }

            .add-to-cart-btn i {
                margin-right: 0.5rem;
            }

            .buy-now-btn {
                flex: 1;
                padding: 1rem;
                background-color: var(--secondary-color);
                color: white;
                border: none;
                border-radius: 4px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .buy-now-btn:hover {
                background-color: #d35400;
            }

            .buy-now-btn i {
                margin-right: 0.5rem;
            }

            .seller-info {
                display: flex;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1.5rem;
                border-bottom: 1px solid var(--border-color);
            }

            .seller-avatar {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background-color: #f0f0f0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                color: var(--primary-color);
                margin-right: 1rem;
            }

            .seller-details {
                flex: 1;
            }

            .seller-name {
                font-weight: 600;
                color: var(--dark-color);
                margin-bottom: 0.2rem;
            }

            .seller-email {
                display: flex;
                align-items: center;
                color: #666;
                font-size: 0.9rem;
            }

            .seller-email i {
                color: var(--primary-color);
                margin-right: 0.5rem;
            }

            .book-description {
                margin-bottom: 2rem;
            }

            .description-title {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--dark-color);
                margin-bottom: 1rem;
            }

            .description-content {
                color: #666;
                line-height: 1.6;
            }

            .book-details {
                margin-bottom: 2rem;
            }

            .details-title {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--dark-color);
                margin-bottom: 1rem;
            }

            .details-table {
                width: 100%;
                border-collapse: collapse;
            }

            .details-table tr {
                border-bottom: 1px solid var(--border-color);
            }

            .details-table tr:last-child {
                border-bottom: none;
            }

            .details-table th {
                padding: 0.8rem 0;
                text-align: left;
                font-weight: 600;
                color: var(--dark-color);
                width: 30%;
            }

            .details-table td {
                padding: 0.8rem 0;
                color: #666;
            }

            .section-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: var(--dark-color);
                margin-bottom: 1.5rem;
            }

            /* Responsive styles */
            @media screen and (max-width: 992px) {
                .book-details-wrapper {
                    flex-direction: column;
                }

                .book-image-gallery {
                    flex: none;
                    width: 100%;
                }

                .main-image {
                    height: 300px;
                }
            }

            @media screen and (max-width: 768px) {
                .book-actions {
                    flex-direction: column;
                }
            }

            @media screen and (max-width: 576px) {
                .seller-info {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .seller-avatar {
                    margin-bottom: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-logo">
                    <img
                        src="../images/bookmarket-logo.png"
                        alt="BookMarket"
                        onerror="this.src='https://via.placeholder.com/30x30?text=BM'; this.onerror='';"
                    />
                    <a href="../index.html">BookMarket</a>
                </div>
                <ul class="navbar-menu">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="browse.html">Browse Books</a></li>
                    <li><a href="sell.html">Sell</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
                <div class="navbar-buttons">
                    <div class="auth-buttons">
                        <a href="login.html" class="btn-login">Login</a>
                        <a href="signup.html" class="btn-signup">Sign Up</a>
                    </div>
                    <a href="#" class="cart-icon"
                        ><i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">0</span></a
                    >
                </div>
                <div class="navbar-toggle">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
        </nav>

        <!-- Notification Container -->
        <div id="notification-container"></div>

        <!-- Book Details Content -->
        <div class="book-details-container">
            <div class="book-details-wrapper">
                <!-- Book Image Gallery -->
                <div class="book-image-gallery">
                    <div class="main-image">
                        <img
                            src="../images/b_cover1.jpg"
                            alt="Book Cover"
                            id="main-book-image"
                        />
                    </div>
                    <div class="thumbnail-images" id="thumbnail-images">
                        <!-- Thumbnails will be loaded dynamically -->
                    </div>
                </div>

                <!-- Book Information -->
                <div class="book-info">
                    <h1 class="book-title" id="book-title">Loading...</h1>
                    <p class="book-author" id="book-author">Loading...</p>

                    <div class="book-category" id="book-category">
                        Loading...
                    </div>

                    <div class="book-price" id="book-price">Loading...</div>

                    <div class="book-condition">
                        <span class="condition-label">Condition:</span>
                        <span class="condition-value" id="book-condition"
                            >Loading...</span
                        >
                    </div>

                    <div class="stock-info">
                        <i class="fas fa-check-circle"></i> Available Items:
                        <span id="stock-count">Loading...</span>
                    </div>

                    <div class="book-actions">
                        <button class="add-to-cart-btn">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                        <button class="buy-now-btn">
                            <i class="fas fa-bolt"></i> Buy Now
                        </button>
                    </div>

                    <div class="seller-info">
                        <div class="seller-avatar" id="seller-avatar">--</div>
                        <div class="seller-details">
                            <div class="seller-name" id="seller-name">
                                Loading...
                            </div>
                            <div class="seller-email">
                                <i class="fas fa-envelope"></i>
                                <span id="seller-email">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="book-description">
                        <h3 class="description-title">About This Book</h3>
                        <div class="description-content">
                            <p id="book-description">Loading...</p>
                        </div>
                    </div>

                    <div class="book-details">
                        <h3 class="details-title">Book Details</h3>
                        <table class="details-table">
                            <tr>
                                <th>ISBN</th>
                                <td id="book-isbn">Loading...</td>
                            </tr>
                            <tr>
                                <th>Category</th>
                                <td id="book-category-detail">Loading...</td>
                            </tr>
                            <tr>
                                <th>Condition</th>
                                <td id="book-condition-detail">Loading...</td>
                            </tr>
                            <tr>
                                <th>Added Date</th>
                                <td id="book-added-date">Loading...</td>
                            </tr>
                            <tr>
                                <th>Seller</th>
                                <td id="book-seller-detail">Loading...</td>
                            </tr>
                            <tr>
                                <th>Contact Email</th>
                                <td id="book-seller-email">Loading...</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-top">
                    <div class="footer-column">
                        <h3>BookMarket</h3>
                        <p>
                            Your one-stop destination for buying and selling
                            books online. Find your next favorite book or give
                            your old books a new home.
                        </p>
                        <div class="social-links">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        </div>
                    </div>
                    <div class="footer-column">
                        <h3>Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="../index.html">Home</a></li>
                            <li><a href="browse.html">Browse Books</a></li>
                            <li><a href="sell.html">Sell Books</a></li>
                            <li><a href="about.html">About Us</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul class="footer-links">
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">FAQs</a></li>
                            <li><a href="#">Shipping Policy</a></li>
                            <li><a href="#">Return Policy</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Contact</h3>
                        <ul class="contact-info">
                            <li>
                                <i class="fas fa-map-marker-alt"></i> 123 Book
                                Street, Dhaka, Bangladesh
                            </li>
                            <li>
                                <i class="fas fa-phone"></i> +880 123 456789
                            </li>
                            <li>
                                <i class="fas fa-envelope"></i>
                                support@bookmarket.com
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2023 BookMarket. All Rights Reserved.</p>
                </div>
            </div>
        </footer>

        <!-- JavaScript -->
        <script src="../js/main.js"></script>
        <script src="../js/auth.js"></script>
        <script src="../js/customer-navbar.js"></script>
        <!-- Book Details Specific JavaScript -->
        <script>
            // Simple test to confirm script is loading
            console.log("ðŸš€ Book Details Script Loaded!");

            // Global variables
            let currentBookId = null;
            let bookData = null;

            // Simple initialization - no complex waiting logic
            document.addEventListener("DOMContentLoaded", function () {
                console.log("ðŸŽ¯ Book Details Page Loaded!");
                initializeBookDetailsPage();
            });

            // Fallback initialization
            if (document.readyState !== "loading") {
                console.log(
                    "ðŸ“– DOM already loaded, initializing immediately..."
                );
                initializeBookDetailsPage();
            }

            // Initialize book details page
            function initializeBookDetailsPage() {
                console.log("ðŸš€ Initializing book details page...");

                // Test basic DOM manipulation
                console.log("ðŸ§ª Testing basic DOM manipulation...");
                const testElement = document.getElementById("book-title");
                if (testElement) {
                    testElement.textContent = "TEST: DOM is working!";
                    console.log("âœ… DOM manipulation test passed");
                } else {
                    console.error(
                        "âŒ DOM manipulation test failed - book-title element not found"
                    );
                }

                // Get book ID from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                currentBookId = urlParams.get("id");

                if (!currentBookId) {
                    console.error("âŒ No book ID found in URL");
                    try {
                        showNotification("No book ID provided", "error");
                    } catch (e) {
                        console.error("âŒ showNotification failed:", e);
                    }
                    return;
                }

                console.log("ðŸ“– Loading book details for ID:", currentBookId);

                // Load book details
                loadBookDetails(currentBookId);

                // Initialize UI elements
                initializeUI();
            }

            // Initialize UI elements
            function initializeUI() {
                // Initialize cart count
                initializeCartCount();

                // Image gallery functionality
                const mainImage = document.getElementById("main-book-image");
                const thumbnails = document.querySelectorAll(".thumbnail");

                // Add to cart button
                const addToCartBtn = document.querySelector(".add-to-cart-btn");
                if (addToCartBtn) {
                    addToCartBtn.addEventListener("click", function () {
                        // Check if user is logged in
                        if (!isLoggedIn()) {
                            try {
                                showNotification(
                                    "Please login to add items to cart",
                                    "warning"
                                );
                            } catch (e) {
                                console.error("âŒ showNotification failed:", e);
                            }
                            // Redirect to login page
                            setTimeout(() => {
                                window.location.href = "login.html";
                            }, 1500);
                            return;
                        }

                        // Add to cart functionality
                        addToCart(currentBookId);
                    });
                }

                // Buy now button
                const buyNowBtn = document.querySelector(".buy-now-btn");
                if (buyNowBtn) {
                    buyNowBtn.addEventListener("click", function () {
                        // Check if user is logged in
                        if (!isLoggedIn()) {
                            try {
                                showNotification(
                                    "Please login to purchase books",
                                    "warning"
                                );
                            } catch (e) {
                                console.error("âŒ showNotification failed:", e);
                            }
                            // Redirect to login page
                            setTimeout(() => {
                                window.location.href = "login.html";
                            }, 1500);
                            return;
                        }

                        try {
                            showNotification("Proceeding to checkout!", "info");
                            // Redirect to payment page with book details
                            setTimeout(() => {
                                const paymentUrl = `payment.html?book_id=${currentBookId}&action=buy_now`;
                                window.location.href = paymentUrl;
                            }, 1000);
                        } catch (e) {
                            console.error("âŒ showNotification failed:", e);
                        }
                    });
                }
            }

            // Load book details from backend
            function loadBookDetails(bookId) {
                console.log("ðŸ“– Fetching book details for ID:", bookId);
                console.log("ðŸ”— API URL:", "../backend/api/book_details.php");

                const form = new FormData();
                form.append("action", "get_book_details");
                form.append("book_id", bookId);

                console.log("ðŸ“¤ Form data:", {
                    action: "get_book_details",
                    book_id: bookId,
                });

                fetch("../backend/api/book_details.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => {
                        console.log("ðŸ“¡ Response status:", response.status);
                        console.log("ðŸ“¡ Response headers:", response.headers);

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`
                            );
                        }

                        return response.json();
                    })
                    .then((data) => {
                        console.log("ðŸ“– Book details response:", data);

                        if (data.success) {
                            console.log("âœ… Data received successfully");
                            bookData = data.data;
                            console.log("ðŸ“š Book data:", bookData);

                            displayBookDetails(bookData);
                            displayReviews(bookData.reviews);
                        } else {
                            console.error(
                                "âŒ API returned error:",
                                data.message
                            );

                            try {
                                showNotification(
                                    data.message ||
                                        "Failed to load book details",
                                    "error"
                                );
                            } catch (e) {
                                console.error("âŒ showNotification failed:", e);
                            }
                            displayError();
                        }
                    })
                    .catch((error) => {
                        console.error("âŒ Error loading book details:", error);

                        try {
                            showNotification(
                                "Failed to load book details",
                                "error"
                            );
                        } catch (e) {
                            console.error("âŒ showNotification failed:", e);
                        }
                        displayError();
                    });
            }

            // Display book details in the UI
            function displayBookDetails(data) {
                console.log("ðŸŽ¨ Starting to display book details...");
                const book = data.book;
                console.log("ðŸ“– Book object:", book);

                // Update page title
                document.title = `${book.title} - BookMarket`;
                console.log("ðŸ“ Page title updated");

                // Update main book image
                const mainImage = document.getElementById("main-book-image");
                console.log("ðŸ–¼ï¸ Main image element:", mainImage);
                if (book.cover_image_path) {
                    mainImage.src = `../${book.cover_image_path}`;
                    mainImage.alt = book.title;
                    console.log(
                        "ðŸ–¼ï¸ Main image updated with:",
                        `../${book.cover_image_path}`
                    );
                } else {
                    console.log("ðŸ–¼ï¸ No cover image path, using default");
                }

                // Update book information
                console.log("ðŸ“š Updating book information elements...");

                const titleElement = document.getElementById("book-title");
                console.log("ðŸ“š Title element:", titleElement);
                if (titleElement) {
                    titleElement.textContent = book.title;
                    console.log("âœ… Title updated to:", book.title);
                } else {
                    console.error("âŒ Title element not found!");
                }

                const authorElement = document.getElementById("book-author");
                console.log("ðŸ“š Author element:", authorElement);
                if (authorElement) {
                    authorElement.textContent = `by ${book.author}`;
                    console.log("âœ… Author updated to:", `by ${book.author}`);
                } else {
                    console.error("âŒ Author element not found!");
                }

                const categoryElement =
                    document.getElementById("book-category");
                console.log("ðŸ“š Category element:", categoryElement);
                if (categoryElement) {
                    categoryElement.textContent = book.category_name;
                    console.log("âœ… Category updated to:", book.category_name);
                } else {
                    console.error("âŒ Category element not found!");
                }

                const priceElement = document.getElementById("book-price");
                console.log("ðŸ“š Price element:", priceElement);
                if (priceElement) {
                    priceElement.textContent = `à§³${book.price}`;
                    console.log("âœ… Price updated to:", `à§³${book.price}`);
                } else {
                    console.error("âŒ Price element not found!");
                }

                const conditionElement =
                    document.getElementById("book-condition");
                console.log("ðŸ“š Condition element:", conditionElement);
                if (conditionElement) {
                    conditionElement.textContent = book.book_condition;
                    console.log(
                        "âœ… Condition updated to:",
                        book.book_condition
                    );
                } else {
                    console.error("âŒ Condition element not found!");
                }

                const descriptionElement =
                    document.getElementById("book-description");
                console.log("ðŸ“š Description element:", descriptionElement);
                if (descriptionElement) {
                    descriptionElement.textContent =
                        book.description || "No description available.";
                    console.log("âœ… Description updated");
                } else {
                    console.error("âŒ Description element not found!");
                }

                console.log("ðŸ“‹ Updating book details table...");

                // Update book details table
                const isbnElement = document.getElementById("book-isbn");
                if (isbnElement) {
                    isbnElement.textContent = book.isbn || "N/A";
                    console.log("âœ… ISBN updated to:", book.isbn || "N/A");
                }

                const categoryDetailElement = document.getElementById(
                    "book-category-detail"
                );
                if (categoryDetailElement) {
                    categoryDetailElement.textContent = book.category_name;
                    console.log(
                        "âœ… Category detail updated to:",
                        book.category_name
                    );
                }

                const conditionDetailElement = document.getElementById(
                    "book-condition-detail"
                );
                if (conditionDetailElement) {
                    conditionDetailElement.textContent = book.book_condition;
                    console.log(
                        "âœ… Condition detail updated to:",
                        book.book_condition
                    );
                }

                const addedDateElement =
                    document.getElementById("book-added-date");
                if (addedDateElement) {
                    addedDateElement.textContent = formatDate(book.created_at);
                    console.log(
                        "âœ… Added date updated to:",
                        formatDate(book.created_at)
                    );
                }

                const sellerDetailElement =
                    document.getElementById("book-seller-detail");
                if (sellerDetailElement) {
                    sellerDetailElement.textContent = book.seller_name;
                    console.log(
                        "âœ… Seller detail updated to:",
                        book.seller_name
                    );
                }

                console.log("ðŸ‘¤ Updating seller information...");

                // Update seller information
                const sellerNameElement =
                    document.getElementById("seller-name");
                if (sellerNameElement) {
                    sellerNameElement.textContent = book.seller_name;
                    console.log("âœ… Seller name updated to:", book.seller_name);
                }

                const sellerAvatarElement =
                    document.getElementById("seller-avatar");
                if (sellerAvatarElement) {
                    sellerAvatarElement.textContent = getInitials(
                        book.seller_name
                    );
                    console.log(
                        "âœ… Seller avatar updated to:",
                        getInitials(book.seller_name)
                    );
                }

                // Update seller email
                const sellerEmailElement =
                    document.getElementById("seller-email");
                if (sellerEmailElement) {
                    sellerEmailElement.textContent = book.seller_email || "N/A";
                    console.log(
                        "âœ… Seller email updated to:",
                        book.seller_email || "N/A"
                    );
                }

                // Update seller email in details table
                const sellerEmailDetailElement =
                    document.getElementById("book-seller-email");
                if (sellerEmailDetailElement) {
                    sellerEmailDetailElement.textContent =
                        book.seller_email || "N/A";
                    console.log(
                        "âœ… Seller email detail updated to:",
                        book.seller_email || "N/A"
                    );
                }

                // Update stock count
                const stockCountElement =
                    document.getElementById("stock-count");
                if (stockCountElement) {
                    stockCountElement.textContent = book.stock_quantity || 0;
                    console.log(
                        "âœ… Stock count updated to:",
                        book.stock_quantity || 0
                    );
                }

                // Update thumbnails
                updateThumbnails(book);
                console.log("ðŸ–¼ï¸ Thumbnails updated");

                console.log("âœ… Book details displayed successfully");
            }

            // Display reviews (placeholder for future implementation)
            function displayReviews(reviews) {
                // This will be implemented when reviews are added
                console.log("ðŸ“ Reviews data:", reviews);
            }

            // Update thumbnails
            function updateThumbnails(book) {
                const thumbnailsContainer =
                    document.getElementById("thumbnail-images");

                // Clear existing thumbnails
                thumbnailsContainer.innerHTML = "";

                // Add main image as first thumbnail
                const mainThumbnail = document.createElement("div");
                mainThumbnail.className = "thumbnail active";
                mainThumbnail.setAttribute(
                    "data-image",
                    book.cover_image_path
                        ? `../${book.cover_image_path}`
                        : "../images/b_cover1.jpg"
                );

                const mainThumbImg = document.createElement("img");
                mainThumbImg.src = book.cover_image_path
                    ? `../${book.cover_image_path}`
                    : "../images/b_cover1.jpg";
                mainThumbImg.alt = `${book.title} - Main Image`;

                mainThumbnail.appendChild(mainThumbImg);
                thumbnailsContainer.appendChild(mainThumbnail);

                // Add additional images if available
                if (book.additional_images) {
                    try {
                        const additionalImages = JSON.parse(
                            book.additional_images
                        );
                        additionalImages.forEach((imagePath, index) => {
                            const thumbnail = document.createElement("div");
                            thumbnail.className = "thumbnail";
                            thumbnail.setAttribute(
                                "data-image",
                                `../${imagePath}`
                            );

                            const img = document.createElement("img");
                            img.src = `../${imagePath}`;
                            img.alt = `${book.title} - Image ${index + 2}`;

                            thumbnail.appendChild(img);
                            thumbnailsContainer.appendChild(thumbnail);
                        });
                    } catch (e) {
                        console.log("No additional images to display");
                    }
                }

                // Add click event listeners to thumbnails
                const thumbnails =
                    thumbnailsContainer.querySelectorAll(".thumbnail");
                thumbnails.forEach((thumbnail) => {
                    thumbnail.addEventListener("click", function () {
                        const mainImage =
                            document.getElementById("main-book-image");
                        mainImage.src = this.getAttribute("data-image");

                        thumbnails.forEach((thumb) =>
                            thumb.classList.remove("active")
                        );
                        this.classList.add("active");
                    });
                });
            }

            // Format date
            function formatDate(dateString) {
                if (!dateString) return "N/A";

                const date = new Date(dateString);
                return date.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                });
            }

            // Get initials from name
            function getInitials(name) {
                if (!name) return "--";
                return name
                    .split(" ")
                    .map((word) => word.charAt(0))
                    .join("")
                    .toUpperCase()
                    .substring(0, 2);
            }

            // Display error state
            function displayError() {
                document.getElementById("book-title").textContent =
                    "Book Not Found";
                document.getElementById("book-author").textContent =
                    "Unable to load book details";
                document.getElementById("book-description").textContent =
                    "The requested book could not be found or is no longer available.";
            }

            // Add to cart functionality
            function addToCart(bookId) {
                // Check if user is logged in
                const user = JSON.parse(
                    localStorage.getItem("bookmarket_user") || "{}"
                );
                if (!user.userId) {
                    try {
                        showNotification(
                            "Please login to add items to cart",
                            "warning"
                        );
                    } catch (e) {
                        console.error("âŒ showNotification failed:", e);
                    }
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 1500);
                    return;
                }

                if (!bookData || !bookData.book) {
                    try {
                        showNotification("Book data not available", "error");
                    } catch (e) {
                        console.error("âŒ showNotification failed:", e);
                    }
                    return;
                }

                // Add to cart via API
                const form = new FormData();
                form.append("action", "add_to_cart");
                form.append("user_id", user.userId);
                form.append("book_id", bookId);
                form.append("quantity", 1);

                fetch("../backend/cart/cart_manager.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            try {
                                showNotification(data.message, "success");
                            } catch (e) {
                                console.error("âŒ showNotification failed:", e);
                            }

                            // Update cart count in navbar
                            updateCartCountFromDatabase();

                            // Redirect to cart page after successful addition
                            setTimeout(() => {
                                window.location.href = "cart.html";
                            }, 1500);
                        } else {
                            try {
                                showNotification(
                                    data.message || "Failed to add to cart",
                                    "error"
                                );
                            } catch (e) {
                                console.error("âŒ showNotification failed:", e);
                            }
                        }
                    })
                    .catch((error) => {
                        console.error("Add to cart error:", error);
                        try {
                            showNotification(
                                "Failed to add to cart. Please try again.",
                                "error"
                            );
                        } catch (e) {
                            console.error("âŒ showNotification failed:", e);
                        }
                    });
            }

            // Update cart count from database
            function updateCartCountFromDatabase() {
                const user = JSON.parse(
                    localStorage.getItem("bookmarket_user") || "{}"
                );
                if (!user.userId) return;

                const form = new FormData();
                form.append("action", "get_cart_count");
                form.append("user_id", user.userId);

                fetch("../backend/cart/cart_manager.php", {
                    method: "POST",
                    body: form,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success !== false) {
                            const cartCountElements =
                                document.querySelectorAll(".cart-count");
                            cartCountElements.forEach((element) => {
                                element.textContent = data.count || 0;
                            });
                        }
                    })
                    .catch((error) => {
                        console.error("Failed to update cart count:", error);
                        console.error("Failed to update cart count:", error);
                    });
            }

            // Check if user is logged in (helper function)
            function isLoggedIn() {
                return localStorage.getItem("bookmarket_user") !== null;
            }

            // Get user type (helper function)
            function getUserType() {
                const user = localStorage.getItem("bookmarket_user");
                return user ? JSON.parse(user).userType : null;
            }

            // Initialize cart count from database
            function initializeCartCount() {
                updateCartCountFromDatabase();
            }
        </script>
    </body>
</html>
