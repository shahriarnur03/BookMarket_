<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>User Management - Admin Dashboard</title>
        <link rel="stylesheet" href="../../css/styles.css" />
        <!-- Additional CSS for User Management page -->
        <style>
            .user-management-container {
                max-width: var(--container-width);
                margin: 2rem auto;
                padding: 0 1rem;
            }

            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .page-title {
                margin: 0;
                color: var(--dark-color);
            }

            .search-filters {
                display: flex;
                gap: 1rem;
                flex-wrap: wrap;
                align-items: center;
            }

            .search-input {
                padding: 0.5rem 1rem;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                min-width: 200px;
            }

            .filter-select {
                padding: 0.5rem 1rem;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                background-color: white;
            }

            .users-table-container {
                background-color: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .table-header {
                padding: 1.5rem;
                border-bottom: 1px solid var(--border-color);
                background-color: #f8f9fa;
            }

            .table-title {
                margin: 0;
                font-size: 1.2rem;
                color: var(--dark-color);
            }

            .table-responsive {
                overflow-x: auto;
            }

            .admin-table {
                width: 100%;
                border-collapse: collapse;
            }

            .admin-table th,
            .admin-table td {
                padding: 1rem;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
            }

            .admin-table th {
                font-weight: 600;
                color: var(--dark-color);
                background-color: #f8f9fa;
            }

            .admin-table tr:last-child td {
                border-bottom: none;
            }

            .admin-table tr:hover {
                background-color: #f8f9fa;
            }

            .user-type-badge {
                display: inline-block;
                padding: 0.3rem 0.8rem;
                border-radius: 50px;
                font-size: 0.8rem;
                font-weight: 600;
            }

            .user-type-admin {
                background-color: rgba(74, 111, 165, 0.1);
                color: var(--primary-color);
            }

            .user-type-customer {
                background-color: rgba(52, 152, 219, 0.1);
                color: #3498db;
            }

            .action-buttons {
                display: flex;
                gap: 0.5rem;
            }

            .action-button {
                padding: 0.3rem 0.8rem;
                border-radius: 4px;
                font-size: 0.8rem;
                cursor: pointer;
                border: none;
                transition: all 0.3s ease;
            }

            .btn-view {
                background-color: var(--primary-color);
                color: white;
            }

            .btn-view:hover {
                background-color: #3a5a80;
            }

            .btn-delete {
                background-color: var(--danger-color);
                color: white;
            }

            .btn-delete:hover {
                background-color: #c0392b;
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
                margin-top: 2rem;
                padding: 1rem;
            }

            .pagination button {
                padding: 0.5rem 1rem;
                border: 1px solid var(--border-color);
                background-color: white;
                cursor: pointer;
                border-radius: 4px;
                transition: all 0.3s ease;
            }

            .pagination button:hover:not(:disabled) {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .pagination button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .pagination .current-page {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .stats-summary {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                background-color: white;
                border-radius: 8px;
                padding: 1.5rem;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                text-align: center;
            }

            .stat-value {
                font-size: 2rem;
                font-weight: 700;
                color: var(--primary-color);
                margin-bottom: 0.5rem;
            }

            .stat-label {
                color: #666;
                font-size: 0.9rem;
            }

            .no-data {
                text-align: center;
                padding: 3rem;
                color: #666;
                font-style: italic;
            }

            .loading {
                text-align: center;
                padding: 3rem;
                color: #666;
            }

            @media screen and (max-width: 768px) {
                .page-header {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .search-filters {
                    width: 100%;
                    justify-content: flex-start;
                }

                .search-input {
                    min-width: 150px;
                }

                .action-buttons {
                    flex-direction: column;
                    gap: 0.3rem;
                }
            }
        </style>
        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
    </head>
    <body>
        <!-- Navbar (Common Admin Navbar) -->
        <nav class="navbar">
            <!-- Navbar will be generated by admin-navbar.js -->
        </nav>

        <!-- User Management Content -->
        <div class="user-management-container">
            <div class="page-header">
                <h1 class="page-title">User Management</h1>
                <div class="search-filters">
                    <input
                        type="text"
                        class="search-input"
                        id="search-input"
                        placeholder="Search users..."
                    />

                    <select class="filter-select" id="type-filter">
                        <option value="">All Types</option>
                        <option value="admin">Admin</option>
                        <option value="customer">Customer</option>
                    </select>
                </div>
            </div>

            <!-- Stats Summary -->
            <div class="stats-summary">
                <div class="stat-card">
                    <div class="stat-value" id="total-users">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="admin-users">0</div>
                    <div class="stat-label">Admin Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="customer-users">0</div>
                    <div class="stat-label">Customer Users</div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="users-table-container">
                <div class="table-header">
                    <h3 class="table-title">All Users</h3>
                </div>
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Joined Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="8" class="loading">
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination" style="display: none">
                <button id="prev-page" disabled>Previous</button>
                <span id="page-info">Page 1 of 1</span>
                <button id="next-page" disabled>Next</button>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notification-container" class="notification-container"></div>

        <!-- JavaScript -->
        <script src="../../js/main.js"></script>
        <script src="../../js/auth.js"></script>
        <script src="../../js/admin-navbar.js"></script>

        <script>
            let currentPage = 1;
            const usersPerPage = 10;
            let allUsers = [];
            let filteredUsers = [];

            document.addEventListener("DOMContentLoaded", function () {
                // Check authentication first
                checkAdminAuth();

                // Initialize search and filters
                initializeFilters();

                // Load initial data
                loadUsers();
                loadUserStats();
            });

            // Check if user is authenticated as admin
            function checkAdminAuth() {
                const form = new FormData();
                form.append("action", "check_admin_auth");

                fetch("../../backend/auth/user_auth.php", {
                    method: "POST",
                    body: form,
                })
                    .then((r) => r.json())
                    .then((d) => {
                        if (!d.success) {
                            showNotification(
                                "Access denied. Please login as admin.",
                                "error"
                            );
                            setTimeout(() => {
                                window.location.href = "../../pages/login.html";
                            }, 2000);
                            return;
                        }
                        // User is authenticated, continue loading
                    })
                    .catch((error) => {
                        console.error("Auth check error:", error);
                        showNotification(
                            "Authentication failed. Please login again.",
                            "error"
                        );
                        setTimeout(() => {
                            window.location.href = "../../pages/login.html";
                        }, 2000);
                    });
            }

            function initializeFilters() {
                const searchInput = document.getElementById("search-input");
                const typeFilter = document.getElementById("type-filter");

                searchInput.addEventListener("input", filterUsers);
                typeFilter.addEventListener("change", filterUsers);
            }

            function filterUsers() {
                const searchTerm = document
                    .getElementById("search-input")
                    .value.toLowerCase();
                const typeFilter = document.getElementById("type-filter").value;

                filteredUsers = allUsers.filter((user) => {
                    const matchesSearch =
                        user.username.toLowerCase().includes(searchTerm) ||
                        user.email.toLowerCase().includes(searchTerm) ||
                        `${user.first_name} ${user.last_name}`
                            .toLowerCase()
                            .includes(searchTerm);

                    const matchesType =
                        typeFilter === "" || user.user_type === typeFilter;

                    return matchesSearch && matchesType;
                });

                currentPage = 1;
                displayUsers();
                updatePagination();
            }

            function loadUsers() {
                const form = new FormData();
                form.append("action", "get_all_users");

                fetch("../../backend/auth/user_auth.php", {
                    method: "POST",
                    body: form,
                })
                    .then((r) => r.json())
                    .then((d) => {
                        if (d.success && Array.isArray(d.data)) {
                            allUsers = d.data;
                            filteredUsers = [...allUsers];
                            displayUsers();
                            updatePagination();
                        } else {
                            document.getElementById(
                                "users-table-body"
                            ).innerHTML =
                                '<tr><td colspan="7" class="no-data">No users found</td></tr>';
                        }
                    })
                    .catch((error) => {
                        console.error("Load users error:", error);
                        document.getElementById("users-table-body").innerHTML =
                            '<tr><td colspan="8" class="no-data">Failed to load users</td></tr>';
                    });
            }

            function loadUserStats() {
                const form = new FormData();
                form.append("action", "get_user_stats");

                fetch("../../backend/auth/user_auth.php", {
                    method: "POST",
                    body: form,
                })
                    .then((r) => r.json())
                    .then((d) => {
                        if (d.success && d.data) {
                            const stats = d.data;
                            document.getElementById("total-users").textContent =
                                stats.total_users || 0;
                            document.getElementById("admin-users").textContent =
                                stats.admin_users || 0;
                            document.getElementById(
                                "customer-users"
                            ).textContent = stats.customer_users || 0;
                        }
                    })
                    .catch((error) => {
                        console.error("Load user stats error:", error);
                    });
            }

            function displayUsers() {
                const tbody = document.getElementById("users-table-body");
                const startIndex = (currentPage - 1) * usersPerPage;
                const endIndex = startIndex + usersPerPage;
                const pageUsers = filteredUsers.slice(startIndex, endIndex);

                if (pageUsers.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="7" class="no-data">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = "";
                pageUsers.forEach((user) => {
                    const typeClass = `user-type-${user.user_type}`;
                    const typeText =
                        user.user_type === "admin" ? "Admin" : "Customer";

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>#${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.first_name || ""} ${
                        user.last_name || ""
                    }</td>
                        <td>${user.email}</td>
                        <td><span class="user-type-badge ${typeClass}">${typeText}</span></td>
                        <td>${new Date(
                            user.created_at
                        ).toLocaleDateString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-button btn-view" data-user-id="${
                                    user.id
                                }">View</button>
                                <button class="action-button btn-delete" data-user-id="${
                                    user.id
                                }">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function updatePagination() {
                const totalPages = Math.ceil(
                    filteredUsers.length / usersPerPage
                );
                const pagination = document.getElementById("pagination");
                const prevBtn = document.getElementById("prev-page");
                const nextBtn = document.getElementById("next-page");
                const pageInfo = document.getElementById("page-info");

                if (totalPages <= 1) {
                    pagination.style.display = "none";
                    return;
                }

                pagination.style.display = "flex";
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

                prevBtn.onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayUsers();
                        updatePagination();
                    }
                };

                nextBtn.onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayUsers();
                        updatePagination();
                    }
                };
            }

            // Event delegation for action buttons
            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("btn-view")) {
                    const userId = e.target.dataset.userId;
                    if (userId) {
                        window.location.href = `user-details.html?id=${userId}`;
                    }
                } else if (e.target.classList.contains("btn-delete")) {
                    const userId = e.target.dataset.userId;
                    if (
                        userId &&
                        confirm(
                            "Are you sure you want to delete this user? This action cannot be undone."
                        )
                    ) {
                        deleteUser(userId);
                    }
                }
            });

            function deleteUser(userId) {
                const form = new FormData();
                form.append("action", "delete_user");
                form.append("user_id", userId);

                fetch("../../backend/auth/user_auth.php", {
                    method: "POST",
                    body: form,
                })
                    .then((r) => r.json())
                    .then((d) => {
                        if (d.success) {
                            showNotification(
                                "User deleted successfully",
                                "success"
                            );
                            // Reload users and stats
                            loadUsers();
                            loadUserStats();
                        } else {
                            showNotification(
                                "Failed to delete user: " +
                                    (d.message || "Unknown error"),
                                "error"
                            );
                        }
                    })
                    .catch((error) => {
                        console.error("Delete user error:", error);
                        showNotification(
                            "Failed to delete user. Please try again.",
                            "error"
                        );
                    });
            }
        </script>
    </body>
</html>
