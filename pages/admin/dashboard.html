<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin Dashboard - BookMarket</title>
        <link rel="stylesheet" href="../../css/styles.css" />
        <!-- Additional CSS for Admin Dashboard page -->
        <style>
            /* Admin Dashboard Page Specific Styles */
            .dashboard-container {
                max-width: var(--container-width);
                margin: 2rem auto;
                padding: 0 1rem;
            }

            .dashboard-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 2rem;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .welcome-message h1 {
                margin-bottom: 0.5rem;
                color: var(--dark-color);
            }

            .welcome-message p {
                color: #666;
            }

            .dashboard-layout {
                display: flex;
                gap: 2rem;
            }

            .dashboard-sidebar {
                width: 250px;
                flex-shrink: 0;
            }

            .dashboard-content {
                flex: 1;
            }

            .sidebar-menu {
                background-color: #2c3e50;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar-menu-item {
                padding: 1rem 1.5rem;
                display: flex;
                align-items: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                cursor: pointer;
                transition: all 0.3s ease;
                color: white;
                text-decoration: none;
            }

            .sidebar-menu-item:last-child {
                border-bottom: none;
            }

            .sidebar-menu-item.active {
                background-color: var(--primary-color);
            }

            .sidebar-menu-item:hover:not(.active) {
                background-color: rgba(255, 255, 255, 0.1);
            }

            .sidebar-menu-item i {
                margin-right: 0.8rem;
                width: 20px;
                text-align: center;
            }

            .stats-cards {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                background-color: white;
                border-radius: 8px;
                padding: 1.5rem;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                position: relative;
                overflow: hidden;
            }

            .stat-icon {
                position: absolute;
                top: 1rem;
                right: 1rem;
                font-size: 1.2rem;
                color: rgba(0, 0, 0, 0.1);
            }

            .stat-label {
                font-size: 0.9rem;
                color: #666;
                margin-bottom: 0.5rem;
            }

            .stat-value {
                font-size: 1.8rem;
                font-weight: 700;
                color: var(--dark-color);
            }

            .stat-trend {
                font-size: 0.8rem;
                margin-top: 0.5rem;
            }

            .trend-up {
                color: var(--success-color);
            }

            .trend-down {
                color: var(--danger-color);
            }

            .stat-books {
                border-top: 3px solid var(--primary-color);
            }

            .stat-delivered-orders {
                border-top: 3px solid var(--success-color);
            }

            .stat-users {
                border-top: 3px solid var(--success-color);
            }

            .stat-pending {
                border-top: 3px solid var(--warning-color);
            }

            .stat-revenue {
                border-top: 3px solid var(--warning-color);
            }

            .stat-total-earnings {
                border-top: 3px solid var(--primary-color);
            }

            .section-card {
                background-color: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                margin-bottom: 2rem;
            }

            .section-header {
                padding: 1rem 1.5rem;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .section-title {
                margin: 0;
                font-size: 1.2rem;
                color: var(--dark-color);
            }

            .section-action {
                color: var(--primary-color);
                text-decoration: none;
                font-size: 0.9rem;
                font-weight: 600;
            }

            .section-content {
                padding: 1.5rem;
            }

            .charts-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }

            .charts-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 2rem;
                margin-bottom: 2rem;
            }

            .chart-container {
                position: relative;
                height: 300px;
                width: 100%;
            }

            .chart-container canvas {
                width: 100% !important;
                height: 100% !important;
            }

            /* Responsive Design for Charts */
            @media screen and (max-width: 768px) {
                .charts-grid {
                    grid-template-columns: 1fr;
                    gap: 1.5rem;
                }

                .chart-container {
                    height: 250px;
                }
            }

            @media screen and (max-width: 576px) {
                .stats-cards {
                    grid-template-columns: repeat(2, 1fr);
                }

                .charts-container {
                    grid-template-columns: 1fr;
                }
            }

            .chart-box {
                height: 300px;
                position: relative;
            }

            .chart-placeholder {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #777;
                font-style: italic;
            }

            .table-responsive {
                overflow-x: auto;
            }

            .admin-table {
                width: 100%;
                border-collapse: collapse;
            }

            .admin-table th,
            .admin-table td {
                padding: 1rem;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
            }

            .admin-table th {
                font-weight: 600;
                color: var(--dark-color);
            }

            .admin-table tr:last-child td {
                border-bottom: none;
            }

            .status-badge {
                display: inline-block;
                padding: 0.3rem 0.8rem;
                border-radius: 50px;
                font-size: 0.8rem;
                font-weight: 600;
            }

            .status-pending {
                background-color: rgba(243, 156, 18, 0.1);
                color: var(--warning-color);
            }

            .status-processing {
                background-color: rgba(74, 111, 165, 0.1);
                color: var(--primary-color);
            }

            .status-shipped {
                background-color: rgba(52, 152, 219, 0.1);
                color: #3498db;
            }

            .status-delivered {
                background-color: rgba(39, 174, 96, 0.1);
                color: var(--success-color);
            }

            .status-cancelled {
                background-color: rgba(231, 76, 60, 0.1);
                color: var(--danger-color);
            }

            .action-buttons {
                display: flex;
                gap: 0.5rem;
            }

            .action-button {
                padding: 0.3rem 0.8rem;
                border-radius: 4px;
                font-size: 0.8rem;
                cursor: pointer;
                border: none;
                transition: all 0.3s ease;
            }

            .btn-view {
                background-color: var(--primary-color);
                color: white;
            }

            .btn-view:hover {
                background-color: #3a5a80;
            }

            /* Responsive styles */
            @media screen and (max-width: 992px) {
                .dashboard-layout {
                    flex-direction: column;
                }

                .dashboard-sidebar {
                    width: 100%;
                }

                .charts-container {
                    grid-template-columns: 1fr;
                }
            }

            @media screen and (max-width: 768px) {
                .stats-cards {
                    grid-template-columns: repeat(2, 1fr);
                }
            }

            @media screen and (max-width: 576px) {
                .stats-cards {
                    grid-template-columns: 1fr;
                }

                .admin-book-grid {
                    grid-template-columns: 1fr;
                }

                .dashboard-header {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .action-buttons {
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .action-button {
                    width: 100%;
                }
            }
        </style>
        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
    </head>
    <body>
        <!-- Navbar (Common Admin Navbar) -->
        <nav class="navbar">
            <!-- Navbar will be generated by admin-navbar.js -->
        </nav>

        <!-- Dashboard Content -->
        <div class="dashboard-container">
            <div class="dashboard-header">
                <div class="welcome-message">
                    <h1>Admin Dashboard</h1>
                    <p>Monitor and manage your BookMarket platform</p>
                </div>
            </div>

            <div class="dashboard-layout">
                <div class="dashboard-content" style="width: 100%">
                    <!-- Stats Overview -->
                    <div class="stats-cards">
                        <div class="stat-card stat-books">
                            <div class="stat-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="stat-label">Total Books</div>
                            <div class="stat-value" id="stat-total-books">
                                0
                            </div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i> 15% from last
                                month
                            </div>
                        </div>

                        <div class="stat-card stat-delivered-orders">
                            <div class="stat-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="stat-label">Delivered Orders</div>
                            <div class="stat-value" id="stat-total-sold-books">
                                0
                            </div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i> 8% from last
                                month
                            </div>
                        </div>

                        <div class="stat-card stat-users">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-label">Total Users</div>
                            <div class="stat-value" id="stat-total-users">
                                0
                            </div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i> 12% from last
                                month
                            </div>
                        </div>

                        <div class="stat-card stat-revenue">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-value" id="stat-total-revenue">
                                à§³0
                            </div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i> 18% from last
                                month
                            </div>
                        </div>

                        <div class="stat-card stat-total-earnings">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-label">
                                Total Platform Earnings
                            </div>
                            <div
                                class="stat-value"
                                id="stat-total-admin-earnings"
                            >
                                à§³0
                            </div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i> 18% from last
                                month
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">Platform Overview</h3>
                        </div>

                        <div class="section-content">
                            <div class="charts-container">
                                <div class="chart-box">
                                    <div
                                        id="chart-books-by-category"
                                        class="chart-placeholder"
                                    >
                                        Books by Category chart will be
                                        displayed here
                                    </div>
                                </div>
                                <div class="chart-box">
                                    <div
                                        id="chart-earnings-overview"
                                        class="chart-placeholder"
                                    >
                                        Earnings Overview chart will be
                                        displayed here
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard Charts -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">Sales Overview</h3>
                        </div>
                        <div class="section-content">
                            <div class="chart-container">
                                <canvas
                                    id="salesChart"
                                    width="400"
                                    height="200"
                                ></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Charts Grid -->
                    <div class="charts-grid">
                        <div class="section-card">
                            <div class="section-header">
                                <h3 class="section-title">Monthly Revenue</h3>
                            </div>
                            <div class="section-content">
                                <div class="chart-container">
                                    <canvas
                                        id="revenueChart"
                                        width="400"
                                        height="300"
                                    ></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header">
                                <h3 class="section-title">Book Categories</h3>
                            </div>
                            <div class="section-content">
                                <div class="chart-container">
                                    <canvas
                                        id="categoriesChart"
                                        width="400"
                                        height="300"
                                    ></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header">
                                <h3 class="section-title">
                                    Order Status Distribution
                                </h3>
                            </div>
                            <div class="section-content">
                                <div class="chart-container">
                                    <canvas
                                        id="orderStatusChart"
                                        width="400"
                                        height="300"
                                    ></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header">
                                <h3 class="section-title">User Growth</h3>
                            </div>
                            <div class="section-content">
                                <div class="chart-container">
                                    <canvas
                                        id="userGrowthChart"
                                        width="400"
                                        height="300"
                                    ></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer (Same as index.html) -->
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-top">
                    <div class="footer-column">
                        <h3>BookMarket</h3>
                        <p>
                            Your one-stop destination for buying and selling
                            books online. Find your next favorite book or give
                            your old books a new home.
                        </p>
                        <div class="social-links">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        </div>
                    </div>
                    <div class="footer-column">
                        <h3>Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="../../index.html">Home</a></li>
                            <li>
                                <a href="order-management.html"
                                    >Order Management</a
                                >
                            </li>
                            <li><a href="../sell.html">Sell Books</a></li>
                            <li><a href="../about.html">About Us</a></li>
                            <li><a href="../contact.html">Contact Us</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul class="footer-links">
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">FAQs</a></li>
                            <li><a href="#">Shipping Policy</a></li>
                            <li><a href="#">Return Policy</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Contact</h3>
                        <ul class="contact-info">
                            <li>
                                <i class="fas fa-map-marker-alt"></i> 123 Book
                                Street, Dhaka, Bangladesh
                            </li>
                            <li>
                                <i class="fas fa-phone"></i> +880 123 456789
                            </li>
                            <li>
                                <i class="fas fa-envelope"></i>
                                support@bookmarket.com
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2023 BookMarket. All Rights Reserved.</p>
                </div>
            </div>
        </footer>

        <!-- Notification Container -->
        <div id="notification-container" class="notification-container"></div>

        <!-- Chart.js CDN -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!-- JavaScript -->
        <script src="../../js/main.js"></script>
        <script src="../../js/auth.js"></script>
        <script src="../../js/admin-navbar.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <!-- Admin Dashboard specific JavaScript -->
        <script>
            /**
             * Admin Dashboard - All charts now use real database data
             *
             * Charts implemented:
             * 1. Sales Overview Chart - Uses get_revenue_timeseries API
             * 2. Monthly Revenue Chart - Uses get_revenue_timeseries API
             * 3. Book Categories Chart - Uses get_categories_with_counts API
             * 4. Order Status Distribution - Uses get_order_stats API
             * 5. User Growth Chart - Uses get_user_growth API
             * 6. Books by Category (ApexCharts) - Uses home_data.php API
             * 7. Earnings Overview (ApexCharts) - Uses get_revenue_timeseries API
             *
             * All hardcoded data has been removed and replaced with real database queries
             */
            document.addEventListener("DOMContentLoaded", function () {
                // Check authentication first
                checkAdminAuth();

                // Logout functionality
                const logoutBtn = document.getElementById("logout-btn");
                const sidebarLogoutBtn =
                    document.getElementById("sidebar-logout");

                // Check if user is authenticated as admin
                function checkAdminAuth() {
                    const form = new FormData();
                    form.append("action", "check_admin_auth");

                    fetch("../../backend/auth/user_auth.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (!d.success) {
                                // Redirect to admin login immediately
                                window.location.href = "login.html";
                                return;
                            }
                            // User is authenticated, continue loading dashboard
                            loadDashboardData();
                        })
                        .catch((error) => {
                            console.error("Auth check error:", error);
                            // Redirect to admin login immediately
                            window.location.href = "login.html";
                        });
                }

                // Load dashboard data after authentication
                function loadDashboardData() {
                    // Initial loads
                    loadStats();
                    initializeCharts();
                    loadCharts();
                }

                function handleLogout() {
                    const form = new FormData();
                    form.append("action", "logout");

                    fetch("../../backend/auth/user_auth.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                showNotification(
                                    "Logged out successfully",
                                    "success"
                                );
                                // Clear any stored user data
                                if (
                                    typeof window.bookmarketAuth !== "undefined"
                                ) {
                                    window.bookmarketAuth.logoutUser();
                                }
                                // Redirect to home page
                                setTimeout(() => {
                                    window.location.href = "../../index.html";
                                }, 1000);
                            } else {
                                showNotification(
                                    "Logout failed: " +
                                        (data.message || "Unknown error"),
                                    "error"
                                );
                            }
                        })
                        .catch((error) => {
                            console.error("Logout error:", error);
                            showNotification(
                                "Logout failed. Please try again.",
                                "error"
                            );
                        });
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        handleLogout();
                    });
                }

                if (sidebarLogoutBtn) {
                    sidebarLogoutBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        handleLogout();
                    });
                }

                // Helpers
                function formatCurrency(amount) {
                    const num = parseFloat(amount || 0);
                    return `à§³${num.toLocaleString("en-BD", {
                        maximumFractionDigits: 2,
                    })}`;
                }

                // Show no data message for charts
                function showNoDataMessage(chartId, message) {
                    const container = document.getElementById(chartId);
                    if (container) {
                        container.innerHTML = `<div class="chart-placeholder">${message}</div>`;
                    }
                }

                function statusBadge(status) {
                    const map = {
                        Pending: "status-pending",
                        Processing: "status-processing",
                        Shipped: "status-shipped",
                        Delivered: "status-delivered",
                        Cancelled: "status-cancelled",
                    };
                    const cls = map[status] || "status-processing";
                    return `<span class="status-badge ${cls}">${status}</span>`;
                }

                // Fetch stats (books + orders + users)
                function loadStats() {
                    // Books stats for total books
                    const booksForm = new FormData();
                    booksForm.append("action", "get_book_stats");
                    fetch("../../backend/books/book_manager.php", {
                        method: "POST",
                        body: booksForm,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && d.data) {
                                const s = d.data;
                                document.getElementById(
                                    "stat-total-books"
                                ).textContent = s.total_books ?? 0;
                            }
                        });

                    // Orders stats for total revenue and commission breakdown
                    const ordersForm = new FormData();
                    ordersForm.append("action", "get_order_stats");
                    fetch("../../backend/orders/order_manager.php", {
                        method: "POST",
                        body: ordersForm,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && d.data) {
                                // Display total revenue
                                document.getElementById(
                                    "stat-total-revenue"
                                ).textContent = formatCurrency(
                                    d.data.total_revenue || 0
                                );

                                // Display total platform earnings
                                document.getElementById(
                                    "stat-total-admin-earnings"
                                ).textContent = formatCurrency(
                                    d.data.total_admin_earnings || 0
                                );

                                // Display total sold books (based on delivered orders)
                                document.getElementById(
                                    "stat-total-sold-books"
                                ).textContent = d.data.delivered_orders || 0;

                                console.log("ðŸ“Š Order Stats:", {
                                    revenue: d.data.total_revenue,
                                    platform_earnings:
                                        d.data.total_admin_earnings,
                                    sold_books: d.data.delivered_orders,
                                });
                            }
                        });

                    // Users stats for total users
                    const usersForm = new FormData();
                    usersForm.append("action", "get_user_stats");
                    fetch("../../backend/auth/user_auth.php", {
                        method: "POST",
                        body: usersForm,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && d.data) {
                                document.getElementById(
                                    "stat-total-users"
                                ).textContent = d.data.total_users ?? 0;
                            }
                        });
                }

                // Initialize Charts
                function initializeCharts() {
                    console.log("ðŸ“Š Initializing dashboard charts...");

                    // Wait for Chart.js to be loaded
                    if (typeof Chart === "undefined") {
                        console.log("Chart.js not loaded yet, retrying...");
                        setTimeout(initializeCharts, 100);
                        return;
                    }

                    // Initialize charts with empty data first
                    // Real data will be loaded and rendered by loadCharts()
                    renderSalesChart([]);
                    renderRevenueChart([]);
                    renderCategoriesChart([]);
                    renderOrderStatusChart({});
                    renderUserGrowthChart([]);
                }

                // Load Charts with Real Database Data
                function loadCharts() {
                    console.log("ðŸ“ˆ Loading real chart data from database...");

                    // Load Chart.js charts
                    loadSalesData();
                    loadRevenueData();
                    loadCategoriesData();
                    loadOrderStatusData();
                    loadUserGrowthData();

                    // Load ApexCharts
                    loadApexCharts();
                }

                // Load Real Sales Data from Database
                function loadSalesData() {
                    const form = new FormData();
                    form.append("action", "get_revenue_timeseries");
                    form.append("months", "12");

                    fetch("../../backend/orders/order_manager.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && d.data) {
                                console.log("ðŸ“Š Sales data loaded:", d.data);
                                renderSalesChart(d.data);
                            } else {
                                console.error(
                                    "Failed to load sales data:",
                                    d.message
                                );
                                renderSalesChart([]); // Render with empty data
                            }
                        })
                        .catch((error) => {
                            console.error("Error loading sales data:", error);
                            renderSalesChart([]); // Render with empty data
                        });
                }

                // Load Real Revenue Data from Database
                function loadRevenueData() {
                    const form = new FormData();
                    form.append("action", "get_revenue_timeseries");
                    form.append("months", "6");

                    fetch("../../backend/orders/order_manager.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && d.data) {
                                console.log("ðŸ“Š Revenue data loaded:", d.data);
                                renderRevenueChart(d.data);
                            } else {
                                console.error(
                                    "Failed to load revenue data:",
                                    d.message
                                );
                                renderRevenueChart([]); // Render with empty data
                            }
                        })
                        .catch((error) => {
                            console.error("Error loading revenue data:", error);
                            renderRevenueChart([]); // Render with empty data
                        });
                }

                // Load Real Categories Data from Database
                function loadCategoriesData() {
                    const form = new FormData();
                    form.append("action", "get_categories_with_counts");

                    fetch("../../backend/api/home_data.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && d.data) {
                                console.log(
                                    "ðŸ“Š Categories data loaded:",
                                    d.data
                                );
                                renderCategoriesChart(d.data);
                            } else {
                                console.error(
                                    "Failed to load categories data:",
                                    d.message
                                );
                                renderCategoriesChart([]); // Render with empty data
                            }
                        })
                        .catch((error) => {
                            console.error(
                                "Error loading categories data:",
                                error
                            );
                            renderCategoriesChart([]); // Render with empty data
                        });
                }

                // Load Real Order Status Data from Database
                function loadOrderStatusData() {
                    const form = new FormData();
                    form.append("action", "get_order_stats");

                    fetch("../../backend/orders/order_manager.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && d.data) {
                                console.log(
                                    "ðŸ“Š Order status data loaded:",
                                    d.data
                                );
                                renderOrderStatusChart(d.data);
                            } else {
                                console.error(
                                    "Failed to load order status data:",
                                    d.message
                                );
                                renderOrderStatusChart([]); // Render with empty data
                            }
                        })
                        .catch((error) => {
                            console.error(
                                "Error loading order status data:",
                                error
                            );
                            renderOrderStatusChart([]); // Render with empty data
                        });
                }

                // Load Real User Growth Data from Database
                function loadUserGrowthData() {
                    const form = new FormData();
                    form.append("action", "get_user_growth");

                    fetch("../../backend/auth/user_auth.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && d.data) {
                                console.log(
                                    "ðŸ“Š User growth data loaded:",
                                    d.data
                                );
                                renderUserGrowthChart(d.data);
                            } else {
                                console.error(
                                    "Failed to load user growth data:",
                                    d.message
                                );
                                renderUserGrowthChart([]); // Render with empty data
                            }
                        })
                        .catch((error) => {
                            console.error(
                                "Error loading user growth data:",
                                error
                            );
                            renderUserGrowthChart([]); // Render with empty data
                        });
                }

                // Sales Overview Chart (Line Chart)
                function renderSalesChart(data = []) {
                    const ctx = document
                        .getElementById("salesChart")
                        .getContext("2d");

                    // Process real data or use fallback
                    let labels = [];
                    let salesData = [];

                    if (data && data.length > 0) {
                        labels = data.map((item) => item.month_label);
                        salesData = data.map((item) =>
                            parseFloat(item.revenue || 0)
                        );
                    } else {
                        // Show no data message
                        showNoDataMessage(
                            "salesChart",
                            "No sales data available"
                        );
                        return;
                    }

                    new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: "Sales",
                                    data: salesData,
                                    borderColor: "#3498db",
                                    backgroundColor: "rgba(52, 152, 219, 0.1)",
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false,
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: "rgba(0, 0, 0, 0.1)",
                                    },
                                    ticks: {
                                        callback: function (value) {
                                            return (
                                                "à§³" +
                                                value.toLocaleString("en-BD")
                                            );
                                        },
                                    },
                                },
                                x: {
                                    grid: {
                                        display: false,
                                    },
                                },
                            },
                            tooltips: {
                                callbacks: {
                                    label: function (tooltipItem, chart) {
                                        return (
                                            "Sales: à§³" +
                                            tooltipItem.yLabel.toLocaleString(
                                                "en-BD"
                                            )
                                        );
                                    },
                                },
                            },
                        },
                    });
                }

                // Monthly Revenue Chart (Bar Chart)
                function renderRevenueChart(data = []) {
                    const ctx = document
                        .getElementById("revenueChart")
                        .getContext("2d");

                    // Process real data or use fallback
                    let labels = [];
                    let revenueData = [];

                    if (data && data.length > 0) {
                        labels = data.map((item) => item.month_label);
                        revenueData = data.map((item) =>
                            parseFloat(item.revenue || 0)
                        );
                    } else {
                        // Show no data message
                        showNoDataMessage(
                            "revenueChart",
                            "No revenue data available"
                        );
                        return;
                    }

                    new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: "Revenue",
                                    data: revenueData,
                                    backgroundColor: [
                                        "#e74c3c",
                                        "#f39c12",
                                        "#f1c40f",
                                        "#2ecc71",
                                        "#3498db",
                                        "#9b59b6",
                                    ],
                                    borderWidth: 0,
                                    borderRadius: 8,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false,
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                },
                            },
                        },
                    });
                }

                // Book Categories Chart (Doughnut Chart)
                function renderCategoriesChart(data = []) {
                    const ctx = document
                        .getElementById("categoriesChart")
                        .getContext("2d");

                    // Process real data or use fallback
                    let labels = [];
                    let categoryData = [];

                    if (data && data.length > 0) {
                        labels = data.map((item) => item.name);
                        categoryData = data.map((item) =>
                            parseInt(item.book_count || 0)
                        );
                    } else {
                        // Show no data message
                        showNoDataMessage(
                            "categoriesChart",
                            "No category data available"
                        );
                        return;
                    }

                    new Chart(ctx, {
                        type: "doughnut",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    data: categoryData,
                                    backgroundColor: [
                                        "#e74c3c",
                                        "#f39c12",
                                        "#f1c40f",
                                        "#2ecc71",
                                        "#3498db",
                                        "#9b59b6",
                                    ],
                                    borderWidth: 0,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: "bottom",
                                },
                            },
                        },
                    });
                }

                // Order Status Distribution (Pie Chart)
                function renderOrderStatusChart(data = {}) {
                    const ctx = document
                        .getElementById("orderStatusChart")
                        .getContext("2d");

                    // Process real data or use fallback
                    let labels = [];
                    let statusData = [];

                    if (data && Object.keys(data).length > 0) {
                        labels = [
                            "Delivered",
                            "Processing",
                            "Shipped",
                            "Cancelled",
                        ];
                        statusData = [
                            parseInt(data.delivered_orders || 0),
                            parseInt(data.processing_orders || 0),
                            parseInt(data.shipped_orders || 0),
                            parseInt(data.cancelled_orders || 0),
                        ];
                    } else {
                        // Show no data message
                        showNoDataMessage(
                            "orderStatusChart",
                            "No order status data available"
                        );
                        return;
                    }

                    new Chart(ctx, {
                        type: "pie",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    data: statusData,
                                    backgroundColor: [
                                        "#2ecc71",
                                        "#f39c12",
                                        "#3498db",
                                        "#e74c3c",
                                    ],
                                    borderWidth: 2,
                                    borderColor: "#fff",
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: "bottom",
                                },
                            },
                        },
                    });
                }

                // User Growth Chart (Area Chart)
                function renderUserGrowthChart(data = []) {
                    const ctx = document
                        .getElementById("userGrowthChart")
                        .getContext("2d");

                    // Process real data or use fallback
                    let labels = [];
                    let userData = [];

                    if (data && data.length > 0) {
                        labels = data.map((item) => item.month_label);
                        userData = data.map((item) =>
                            parseInt(item.new_users || 0)
                        );
                    } else {
                        // Show no data message
                        showNoDataMessage(
                            "userGrowthChart",
                            "No user growth data available"
                        );
                        return;
                    }

                    new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: "New Users",
                                    data: userData,
                                    borderColor: "#27ae60",
                                    backgroundColor: "rgba(39, 174, 96, 0.2)",
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false,
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                },
                            },
                        },
                    });
                }

                // Event delegation for user actions
                document.addEventListener("click", function (e) {
                    if (e.target.classList.contains("btn-view")) {
                        const userId = e.target.dataset.user;
                        const orderId = e.target.dataset.orderId;

                        if (userId) {
                            // View user details
                            window.location.href = `user-details.html?id=${userId}`;
                        } else if (orderId) {
                            // View order details
                            window.location.href = `order-details.html?id=${orderId}`;
                        }
                    } else if (e.target.classList.contains("btn-delete")) {
                        const userId = e.target.dataset.user;
                        if (
                            userId &&
                            confirm(
                                "Are you sure you want to delete this user? This action cannot be undone."
                            )
                        ) {
                            deleteUser(userId);
                        }
                    }
                });

                // Delete user function
                function deleteUser(userId) {
                    const form = new FormData();
                    form.append("action", "delete_user");
                    form.append("user_id", userId);

                    fetch("../../backend/auth/user_auth.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success) {
                                showNotification(
                                    "User deleted successfully",
                                    "success"
                                );
                                // User deleted successfully
                            } else {
                                showNotification(
                                    "Failed to delete user: " +
                                        (d.message || "Unknown error"),
                                    "error"
                                );
                            }
                        })
                        .catch((error) => {
                            console.error("Delete user error:", error);
                            showNotification(
                                "Failed to delete user. Please try again.",
                                "error"
                            );
                        });
                }

                // Charts: Books by Category (donut) and Earnings Overview (area)
                function renderBooksByCategoryChart(categories) {
                    const container = document.getElementById(
                        "chart-books-by-category"
                    );
                    if (!container) return;
                    const labels = categories.map((c) => c.name);
                    const series = categories.map((c) =>
                        parseInt(c.book_count || c.count || 0)
                    );
                    if (!series.length || series.every((v) => v === 0)) {
                        container.textContent = "No category data available";
                        return;
                    }
                    const options = {
                        chart: { type: "donut", height: 300 },
                        labels: labels,
                        series: series,
                        legend: { position: "bottom" },
                        dataLabels: { enabled: true },
                        tooltip: {
                            y: {
                                formatter: function (val) {
                                    return val + " books";
                                },
                            },
                        },
                        colors: [
                            "#1f77b4",
                            "#ff7f0e",
                            "#2ca02c",
                            "#d62728",
                            "#9467bd",
                            "#8c564b",
                            "#e377c2",
                            "#7f7f7f",
                            "#bcbd22",
                            "#17becf",
                        ],
                        responsive: [
                            {
                                breakpoint: 768,
                                options: {
                                    chart: { height: 320 },
                                    legend: { position: "bottom" },
                                },
                            },
                        ],
                    };
                    container.classList.remove("chart-placeholder");
                    const chart = new ApexCharts(container, options);
                    chart.render();
                }

                function renderEarningsOverviewChart(timeseries) {
                    const container = document.getElementById(
                        "chart-earnings-overview"
                    );
                    if (!container) return;
                    const categories = timeseries.map(
                        (p) => p.month_label || p.month
                    );
                    const data = timeseries.map((p) =>
                        parseFloat(p.revenue || 0)
                    );
                    if (!data.length) {
                        container.textContent = "No earnings data available";
                        return;
                    }
                    const options = {
                        chart: {
                            type: "area",
                            height: 300,
                            toolbar: { show: false },
                        },
                        series: [{ name: "Revenue", data: data }],
                        xaxis: { categories: categories },
                        yaxis: {
                            labels: {
                                formatter: function (val) {
                                    return (
                                        "à§³" +
                                        Number(val).toLocaleString("en-BD")
                                    );
                                },
                            },
                        },
                        dataLabels: { enabled: false },
                        stroke: { curve: "smooth", width: 3 },
                        fill: {
                            type: "gradient",
                            gradient: {
                                shadeIntensity: 0.5,
                                opacityFrom: 0.5,
                                opacityTo: 0.1,
                            },
                        },
                        colors: ["#10b981"],
                        tooltip: {
                            y: {
                                formatter: function (val) {
                                    return (
                                        "à§³" +
                                        Number(val).toLocaleString("en-BD")
                                    );
                                },
                            },
                        },
                    };
                    container.classList.remove("chart-placeholder");
                    const chart = new ApexCharts(container, options);
                    chart.render();
                }

                // Load ApexCharts (Books by Category and Earnings Overview)
                function loadApexCharts() {
                    // Books by Category
                    fetch("../../backend/api/home_data.php?action=categories")
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && Array.isArray(d.data)) {
                                const filtered = d.data.filter(
                                    (c) => (c.book_count ?? 0) >= 0
                                );
                                renderBooksByCategoryChart(filtered);
                            }
                        })
                        .catch(() => {
                            const c = document.getElementById(
                                "chart-books-by-category"
                            );
                            if (c) c.textContent = "Failed to load categories";
                        });

                    // Earnings Overview (last 12 months)
                    const form = new FormData();
                    form.append("action", "get_revenue_timeseries");
                    form.append("months", "12");
                    fetch("../../backend/orders/order_manager.php", {
                        method: "POST",
                        body: form,
                    })
                        .then((r) => r.json())
                        .then((d) => {
                            if (d.success && Array.isArray(d.data)) {
                                renderEarningsOverviewChart(d.data);
                            }
                        })
                        .catch(() => {
                            const c = document.getElementById(
                                "chart-earnings-overview"
                            );
                            if (c)
                                c.textContent = "Failed to load earnings data";
                        });
                }

                // All data is now loaded through loadDashboardData()
                // which calls loadStats() and loadCharts()
            });
        </script>
    </body>
</html>
