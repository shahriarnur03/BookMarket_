<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sell Books - BookMarket</title>
        <link rel="stylesheet" href="../css/styles.css" />
        <!-- Additional CSS for Sell page -->
        <style>
            /* Sell Page Specific Styles */
            .sell-container {
                max-width: var(--container-width);
                margin: 0 auto;
                padding: 2rem 1rem;
            }

            .sell-intro {
                text-align: center;
                margin-bottom: 3rem;
            }

            .sell-intro p {
                max-width: 800px;
                margin: 0 auto 1rem;
                color: #555;
                font-size: 1.1rem;
            }

            .sell-steps {
                display: flex;
                justify-content: space-between;
                margin: 3rem 0;
                flex-wrap: wrap;
                gap: 2rem;
            }

            .step-card {
                flex: 1;
                min-width: 250px;
                background-color: white;
                border-radius: 8px;
                padding: 1.5rem;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                text-align: center;
                position: relative;
            }

            .step-number {
                position: absolute;
                top: -20px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 40px;
                background-color: var(--primary-color);
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 1.2rem;
            }

            .step-card h3 {
                margin: 1rem 0;
                color: var(--dark-color);
            }

            .step-card p {
                color: #666;
                font-size: 0.9rem;
            }

            .commission-calculator {
                background-color: var(--dark-color);
                color: white;
                padding: 2rem;
                border-radius: 8px;
                margin-bottom: 3rem;
                text-align: center;
            }

            .calculator-header h3 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }

            .calculator-header p {
                margin-bottom: 2rem;
                color: #ddd;
            }

            .calculator-form {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 1rem;
                margin-bottom: 2rem;
                flex-wrap: wrap;
            }

            .calculator-form label {
                font-size: 1.2rem;
            }

            .calculator-form input {
                width: 150px;
                padding: 0.8rem;
                border: none;
                border-radius: 4px;
                font-size: 1.2rem;
                text-align: center;
            }

            .calculator-form button {
                background-color: var(--secondary-color);
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 4px;
                font-size: 1rem;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

            .calculator-form button:hover {
                background-color: #d35400;
            }

            .btn:disabled {
                background-color: #bdc3c7 !important;
                cursor: not-allowed !important;
                opacity: 0.7 !important;
            }

            .btn:disabled:hover {
                background-color: #bdc3c7 !important;
                transform: none !important;
            }

            .calculator-result {
                font-size: 1.2rem;
            }

            .calculator-result span {
                font-weight: bold;
                color: var(--secondary-color);
                font-size: 1.5rem;
            }

            .sell-form-container {
                background-color: white;
                border-radius: 8px;
                padding: 2rem;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .form-title {
                text-align: center;
                margin-bottom: 2rem;
                color: var(--dark-color);
            }

            .form-group {
                margin-bottom: 1.5rem;
            }

            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 0.8rem;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 1rem;
            }

            .required-field::after {
                content: " *";
                color: #e74c3c;
                font-weight: bold;
            }

            .image-upload.required {
                border-color: #e74c3c;
                background-color: rgba(231, 76, 60, 0.05);
            }

            .image-upload.required label {
                color: #e74c3c;
            }

            .image-upload.required {
                border-color: #e74c3c;
                background-color: rgba(231, 76, 60, 0.05);
            }

            .image-upload.required p {
                color: #e74c3c;
            }

            .form-group textarea {
                height: 150px;
                resize: vertical;
            }

            .form-row {
                display: flex;
                gap: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .form-row .form-group {
                flex: 1;
                margin-bottom: 0;
            }

            .image-upload {
                border: 2px dashed var(--border-color);
                padding: 1.5rem;
                text-align: center;
                border-radius: 4px;
                position: relative;
            }

            .image-preview {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
                min-height: 120px;
            }

            .image-preview:empty::before {
                content: "No images selected";
                color: #999;
                font-style: italic;
                text-align: center;
                grid-column: 1 / -1;
                padding: 2rem;
                background-color: #f9f9f9;
                border-radius: 4px;
                border: 2px dashed #ddd;
            }

            .preview-item {
                width: 120px;
                height: 120px;
                border-radius: 4px;
                overflow: hidden;
                position: relative;
            }

            .preview-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 4px;
            }

            .preview-item {
                position: relative;
                transition: transform 0.2s ease;
            }

            .preview-item:hover {
                transform: scale(1.05);
            }

            .preview-remove {
                position: absolute;
                top: 5px;
                right: 5px;
                width: 24px;
                height: 24px;
                background-color: rgba(231, 76, 60, 0.9);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1rem;
                font-weight: bold;
                transition: all 0.2s ease;
                border: 2px solid white;
            }

            .preview-remove:hover {
                background-color: rgba(231, 76, 60, 1);
                transform: scale(1.1);
            }

            .terms {
                margin: 2rem 0;
                padding: 1rem;
                background-color: #f9f9f9;
                border-radius: 4px;
            }

            .terms-checkbox {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .terms-checkbox input {
                width: 16px;
                height: 16px;
            }

            .form-buttons {
                display: flex;
                justify-content: space-between;
                margin-top: 2rem;
            }

            .condition-guidelines {
                background-color: #f9f9f9;
                padding: 1.5rem;
                border-radius: 8px;
                margin: 3rem 0;
            }

            .condition-guidelines h3 {
                text-align: center;
                margin-bottom: 1.5rem;
                color: var(--dark-color);
            }

            .guidelines-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1.5rem;
            }

            .guideline-item {
                background-color: white;
                padding: 1rem;
                border-radius: 4px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            .guideline-item h4 {
                color: var(--primary-color);
                margin-bottom: 0.5rem;
                display: flex;
                align-items: center;
            }

            .guideline-item h4 i {
                margin-right: 0.5rem;
            }

            .guideline-item p {
                color: #666;
                font-size: 0.9rem;
            }

            .pricing-tips {
                margin-top: 0.5rem;
                font-style: italic;
                color: #888;
            }

            .selling-stories {
                margin: 4rem 0;
            }

            .stories-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 2rem;
            }

            .story-card {
                background-color: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .story-image {
                height: 200px;
                overflow: hidden;
            }

            .story-image .placeholder-image {
                width: 100%;
                height: 100%;
            }

            .story-photo {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 8px 8px 0 0;
            }

            .story-content {
                padding: 1.5rem;
            }

            .story-content h3 {
                margin-bottom: 1rem;
                color: var(--dark-color);
            }

            .story-content p {
                color: #555;
                font-size: 0.9rem;
            }

            @media screen and (max-width: 768px) {
                .form-row {
                    flex-direction: column;
                    gap: 1rem;
                }

                .calculator-form {
                    flex-direction: column;
                    align-items: stretch;
                }

                .calculator-form input {
                    width: 100%;
                }

                .step-card {
                    flex: 100%;
                }
            }
        </style>
        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
    </head>
    <body>
        <!-- Navbar (Common Customer Navbar) -->
        <nav class="navbar">
            <!-- Navbar will be generated by customer-navbar.js -->
        </nav>

        <!-- Sell Page Content -->
        <div class="sell-container">
            <div class="sell-intro">
                <h1 class="section-title">Sell Your Books</h1>
                <p>
                    Turn your old books into cash! BookMarket makes it easy to
                    sell books you no longer need. List your books, set your
                    price, and reach thousands of readers across Bangladesh.
                </p>
                <p>
                    We take only a small 5% commission on each sale, ensuring
                    you get maximum value for your books.
                </p>
            </div>

            <!-- Selling Steps -->
            <div class="sell-steps">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <h3>List Your Book</h3>
                    <p>
                        Fill out our simple form with details about your book
                        and upload clear photos. Be honest about the condition
                        to build trust with buyers.
                    </p>
                </div>

                <div class="step-card">
                    <div class="step-number">2</div>
                    <h3>Get Approved</h3>
                    <p>
                        Our admin team will review your listing to ensure
                        quality. This usually takes less than 24 hours on
                        business days.
                    </p>
                </div>

                <div class="step-card">
                    <div class="step-number">3</div>
                    <h3>Pay Commission</h3>
                    <p>
                        Once approved, pay the 5% commission fee via card
                        payment to list your book on the marketplace.
                    </p>
                </div>

                <div class="step-card">
                    <div class="step-number">4</div>
                    <h3>Ship When Sold</h3>
                    <p>
                        When your book sells, ship it to the buyer using our
                        partners or your preferred shipping method.
                    </p>
                </div>
            </div>

            <!-- Commission Calculator -->
            <div class="commission-calculator">
                <div class="calculator-header">
                    <h3>Commission Calculator</h3>
                    <p>
                        BookMarket takes only 5% commission on each sale. Use
                        this calculator to see how much you'll earn.
                    </p>
                </div>

                <div class="calculator-form">
                    <label for="book-price">Book Price (BDT):</label>
                    <input type="number" id="book-price" min="1" value="500" />
                    <button id="calculate-btn">Calculate</button>
                </div>

                <div class="calculator-result">
                    You will earn:
                    <span id="earning-result">৳475.00</span> after 5% commission
                </div>
            </div>

            <!-- Book Condition Guidelines -->
            <div class="condition-guidelines">
                <h3>Book Condition Guidelines</h3>

                <div class="guidelines-list">
                    <div class="guideline-item">
                        <h4><i class="fas fa-star"></i> New</h4>
                        <p>
                            Brand new, unopened, with no markings or damage.
                            Looks just like it would in a bookstore.
                        </p>
                        <p class="pricing-tips">
                            Suggested pricing: 70-90% of retail price
                        </p>
                    </div>

                    <div class="guideline-item">
                        <h4><i class="fas fa-star-half-alt"></i> Excellent</h4>
                        <p>
                            Like new with minimal wear. Pages are clean, and
                            spine shows no creases.
                        </p>
                        <p class="pricing-tips">
                            Suggested pricing: 50-70% of retail price
                        </p>
                    </div>

                    <div class="guideline-item">
                        <h4><i class="fas fa-check"></i> Good</h4>
                        <p>
                            Shows some wear but remains in good condition. May
                            have some highlighting or notes.
                        </p>
                        <p class="pricing-tips">
                            Suggested pricing: 30-50% of retail price
                        </p>
                    </div>

                    <div class="guideline-item">
                        <h4><i class="fas fa-check-circle"></i> Fair</h4>
                        <p>
                            Heavy wear, but all text is legible. May have
                            writing, highlighting, or damaged cover.
                        </p>
                        <p class="pricing-tips">
                            Suggested pricing: 15-30% of retail price
                        </p>
                    </div>

                    <div class="guideline-item">
                        <h4><i class="fas fa-exclamation-circle"></i> Poor</h4>
                        <p>
                            Significant damage but readable. May be missing
                            pages or have binding issues.
                        </p>
                        <p class="pricing-tips">
                            Suggested pricing: 5-15% of retail price
                        </p>
                    </div>
                </div>
            </div>

            <!-- Selling Stories -->
            <div class="selling-stories">
                <h2 class="section-title">Success Stories</h2>

                <div class="stories-container">
                    <div class="story-card">
                        <div class="story-image">
                            <img
                                src="../images/student_photo.jpeg"
                                alt="Student Photo"
                                class="story-photo"
                            />
                        </div>
                        <div class="story-content">
                            <h3>Funded My New Semester</h3>
                            <p>
                                "I sold my old textbooks from previous semesters
                                and made enough to buy all my new textbooks. The
                                process was so easy, and I got better prices
                                than the campus bookstore offered!"
                            </p>
                            <p>— Samia, DU Student</p>
                        </div>
                    </div>

                    <div class="story-card">
                        <div class="story-image">
                            <img
                                src="../images/book_collector.jpg"
                                alt="Book Collector Photo"
                                class="story-photo"
                            />
                        </div>
                        <div class="story-content">
                            <h3>Decluttered My Collection</h3>
                            <p>
                                "As a book collector, I needed to make space for
                                new additions. I sold over 50 books on
                                BookMarket and found them good homes with
                                readers who appreciate them as much as I did."
                            </p>
                            <p>— Rahul, Book Collector</p>
                        </div>
                    </div>

                    <div class="story-card">
                        <div class="story-image">
                            <img
                                src="../images/teacher_photo.jpg"
                                alt="Teacher Photo"
                                class="story-photo"
                            />
                        </div>
                        <div class="story-content">
                            <h3>Extra Income Source</h3>
                            <p>
                                "I'm a teacher with lots of reference books.
                                Selling the ones I no longer use has become a
                                nice side income. The platform is easy to use
                                and connects me with serious buyers."
                            </p>
                            <p>— Karim, High School Teacher</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sell Book Form -->
            <div class="sell-form-container">
                <h2 class="form-title">Add Your Book</h2>

                <!-- This form will be connected to backend later -->
                <form id="sell-book-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="book-title">Book Title*</label>
                            <input
                                type="text"
                                id="book-title"
                                required
                                placeholder="Enter the full title of the book"
                            />
                        </div>

                        <div class="form-group">
                            <label for="book-author">Author*</label>
                            <input
                                type="text"
                                id="book-author"
                                required
                                placeholder="Enter the author's name"
                            />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="book-quantity">Quantity*</label>
                            <input
                                type="number"
                                id="book-quantity"
                                min="1"
                                value="1"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label for="book-condition">Condition*</label>
                            <select id="book-condition" required>
                                <option value="">Select condition</option>
                                <option value="new">New</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="book-category">Category*</label>
                            <select id="book-category" required>
                                <option value="">Select category</option>
                                <option value="fiction">Fiction</option>
                                <option value="academic">Academic</option>
                                <option value="science">
                                    Science & Technology
                                </option>
                                <option value="business">Business</option>
                                <option value="children">Children</option>
                                <option value="history">History</option>
                                <option value="biography">Biography</option>
                                <option value="self-help">Self-Help</option>
                                <option value="art">Art & Photography</option>
                                <option value="travel">Travel</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="book-price">Price (BDT)*</label>
                            <input
                                type="number"
                                id="book-price-input"
                                required
                                min="1"
                                placeholder="Enter your asking price"
                            />
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="book-isbn">ISBN (Optional)</label>
                        <input
                            type="text"
                            id="book-isbn"
                            placeholder="Enter ISBN if available"
                        />
                    </div>

                    <div class="form-group">
                        <label for="book-description">Description*</label>
                        <textarea
                            id="book-description"
                            required
                            placeholder="Describe your book, including any defects or special features"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="book-images" class="required-field"
                            >Book Images (Max 5MB each)*</label
                        >
                        <div class="image-upload" id="image-upload-section">
                            <input
                                type="file"
                                id="book-images"
                                accept="image/*"
                                multiple
                                required
                                hidden
                            />
                            <label for="book-images" class="btn btn-secondary"
                                >Select Images</label
                            >
                            <p>
                                <strong style="color: #e74c3c"
                                    >⚠️ At least one cover image is
                                    MANDATORY</strong
                                >
                            </p>
                            <p>
                                Click to select one or more images. First image
                                will be used as cover.
                            </p>

                            <div class="image-preview" id="image-preview">
                                <!-- Images will be displayed here after selection -->
                            </div>
                        </div>
                        <small style="color: #e74c3c; font-weight: 500">
                            <i class="fas fa-exclamation-triangle"></i>
                            You must upload at least one image to proceed with
                            book listing.
                        </small>
                    </div>

                    <div class="terms">
                        <div class="terms-checkbox">
                            <input type="checkbox" id="terms-agree" required />
                            <label for="terms-agree"
                                >I agree to the Terms & Conditions and confirm
                                that I own this book and have the right to sell
                                it.</label
                            >
                        </div>
                    </div>

                    <div class="form-buttons">
                        <button
                            type="submit"
                            id="publish-btn"
                            class="btn btn-primary"
                        >
                            Publish Listing
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Footer (Same as index.html) -->
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-top">
                    <div class="footer-column">
                        <h3>BookMarket</h3>
                        <p>
                            Your one-stop destination for buying and selling
                            books online. Find your next favorite book or give
                            your old books a new home.
                        </p>
                        <div class="social-links">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        </div>
                    </div>
                    <div class="footer-column">
                        <h3>Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="../index.html">Home</a></li>
                            <li><a href="browse.html">Browse Books</a></li>
                            <li><a href="sell.html">Sell Books</a></li>
                            <li><a href="about.html">About Us</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul class="footer-links">
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">FAQs</a></li>
                            <li><a href="#">Shipping Policy</a></li>
                            <li><a href="#">Return Policy</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Contact</h3>
                        <ul class="contact-info">
                            <li>
                                <i class="fas fa-map-marker-alt"></i> 123 Book
                                Street, Dhaka, Bangladesh
                            </li>
                            <li>
                                <i class="fas fa-phone"></i> +880 123 456789
                            </li>
                            <li>
                                <i class="fas fa-envelope"></i>
                                support@bookmarket.com
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2023 BookMarket. All Rights Reserved.</p>
                </div>
            </div>
        </footer>

        <!-- Notification Container -->
        <div id="notification-container" class="notification-container"></div>

        <!-- JavaScript -->
        <script src="../js/main.js"></script>
        <script src="../js/auth.js"></script>
        <script src="../js/customer-navbar.js"></script>
        <!-- Sell page specific JavaScript -->
        <script>
            // Global variables for image management
            let uploadedFiles = [];
            let imageUploadStatus = {
                cover: null,
                additional: [],
            };

            document.addEventListener("DOMContentLoaded", function () {
                // Commission Calculator
                const bookPriceInput = document.getElementById("book-price");
                const calculateBtn = document.getElementById("calculate-btn");
                const earningResult = document.getElementById("earning-result");

                calculateBtn.addEventListener("click", function () {
                    const price = parseFloat(bookPriceInput.value);
                    if (!isNaN(price) && price > 0) {
                        const commission = price * 0.05;
                        const earning = price - commission;
                        earningResult.textContent = "৳" + earning.toFixed(2);
                    } else {
                        alert("Please enter a valid price.");
                        bookPriceInput.focus();
                    }
                });

                // Image Upload Preview with validation
                const bookImagesInput = document.getElementById("book-images");
                const imagePreview = document.getElementById("image-preview");
                const imageUploadSection = document.getElementById(
                    "image-upload-section"
                );

                bookImagesInput.addEventListener("change", function () {
                    // Clear previous previews and reset status
                    imagePreview.innerHTML = "";
                    uploadedFiles = [];
                    imageUploadStatus.cover = null;
                    imageUploadStatus.additional = [];

                    // Validate and display each selected image
                    for (let i = 0; i < this.files.length; i++) {
                        const file = this.files[i];

                        // Check file size (5MB limit)
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification(
                                `Image ${file.name} exceeds the 5MB size limit.`,
                                "error"
                            );
                            continue;
                        }

                        // Check file type
                        if (!file.type.startsWith("image/")) {
                            showNotification(
                                `File ${file.name} is not an image.`,
                                "error"
                            );
                            continue;
                        }

                        // Add to uploaded files
                        uploadedFiles.push(file);

                        // Create preview element
                        const previewItem = document.createElement("div");
                        previewItem.className = "preview-item";
                        previewItem.dataset.filename = file.name;

                        // Create image element with actual preview
                        const img = document.createElement("img");
                        img.src = URL.createObjectURL(file);
                        img.alt = file.name;

                        // Create remove button
                        const removeBtn = document.createElement("div");
                        removeBtn.className = "preview-remove";
                        removeBtn.innerHTML = "&times;";

                        // Add click event to remove button
                        removeBtn.addEventListener("click", function () {
                            previewItem.remove();

                            // Remove from uploaded files
                            const index = uploadedFiles.findIndex(
                                (f) => f.name === file.name
                            );
                            if (index > -1) {
                                uploadedFiles.splice(index, 1);
                            }

                            // Update status
                            updateImageUploadStatus();
                        });

                        // Append elements
                        previewItem.appendChild(img);
                        previewItem.appendChild(removeBtn);
                        imagePreview.appendChild(previewItem);
                    }

                    // Update status after adding images
                    updateImageUploadStatus();
                });

                // Update image upload status and styling
                function updateImageUploadStatus() {
                    if (uploadedFiles.length === 0) {
                        imageUploadSection.classList.add("required");
                        imageUploadStatus.cover = null;
                        imageUploadStatus.additional = [];
                    } else {
                        imageUploadSection.classList.remove("required");
                        imageUploadStatus.cover = uploadedFiles[0];
                        imageUploadStatus.additional = uploadedFiles.slice(1);
                    }
                }

                // Form Submit with proper validation
                const sellBookForm = document.getElementById("sell-book-form");
                const publishBtn = document.getElementById("publish-btn");

                sellBookForm.addEventListener("submit", function (e) {
                    e.preventDefault();

                    // Basic form validation
                    const title = document
                        .getElementById("book-title")
                        .value.trim();
                    const author = document
                        .getElementById("book-author")
                        .value.trim();
                    const condition =
                        document.getElementById("book-condition").value;
                    const category =
                        document.getElementById("book-category").value;
                    const price =
                        document.getElementById("book-price-input").value;
                    const description = document
                        .getElementById("book-description")
                        .value.trim();
                    const termsAgreed =
                        document.getElementById("terms-agree").checked;

                    // Check if all required fields are filled
                    if (
                        !title ||
                        !author ||
                        !condition ||
                        !category ||
                        !price ||
                        !description
                    ) {
                        showNotification(
                            "Please fill in all required fields.",
                            "error"
                        );
                        return;
                    }

                    // Check if user has agreed to terms
                    if (!termsAgreed) {
                        showNotification(
                            "Please agree to the Terms & Conditions.",
                            "warning"
                        );
                        return;
                    }

                    // Check if images are uploaded
                    if (uploadedFiles.length === 0) {
                        showNotification(
                            "Please upload at least one image for your book.",
                            "error"
                        );
                        imageUploadSection.classList.add("required");
                        return;
                    }

                    // Proceed with publishing
                    publishListing();
                });

                async function publishListing() {
                    try {
                        // Check user authentication
                        const user =
                            window.bookmarketAuth?.getUserId?.() ||
                            JSON.parse(
                                localStorage.getItem("bookmarket_user") || "{}"
                            ).userId ||
                            JSON.parse(
                                localStorage.getItem("bookmarket_user") || "{}"
                            ).id;

                        if (!user) {
                            showNotification(
                                "Please login to publish your listing",
                                "warning"
                            );
                            return;
                        }

                        // Show loading state
                        publishBtn.disabled = true;
                        publishBtn.innerHTML =
                            '<i class="fas fa-spinner fa-spin"></i> Publishing...';

                        // First upload images
                        console.log("Uploading images...");
                        const imageUploads = await uploadImages();

                        if (!imageUploads.success) {
                            throw new Error(imageUploads.message);
                        }

                        // Check if cover image was uploaded successfully
                        if (
                            !imageUploads.coverImagePath ||
                            imageUploads.coverImagePath.trim() === ""
                        ) {
                            throw new Error(
                                "Cover image upload failed. Please try uploading the image again."
                            );
                        }

                        console.log("Images uploaded successfully");

                        // Then create the book
                        console.log("Creating book...");
                        const bookData = getFormData();
                        bookData.cover_image_path = imageUploads.coverImagePath;
                        bookData.additional_images = JSON.stringify(
                            imageUploads.additionalImagePaths
                        );

                        console.log("Final book data being sent:", bookData);

                        const result = await createBook(bookData);
                        console.log("Book creation result:", result);

                        if (result.success) {
                            showNotification(
                                "Your book listing has been submitted successfully! It will be reviewed by admin.",
                                "success"
                            );
                            sellBookForm.reset();
                            imagePreview.innerHTML = "";
                            uploadedFiles = [];
                            updateImageUploadStatus();
                        } else {
                            throw new Error(
                                result.message || "Failed to create book"
                            );
                        }
                    } catch (error) {
                        console.error("Publish error:", error);
                        showNotification(
                            "Failed to publish listing: " + error.message,
                            "error"
                        );
                    } finally {
                        // Reset button state
                        publishBtn.disabled = false;
                        publishBtn.innerHTML = "Publish Listing";
                    }
                }

                // Upload images to server
                async function uploadImages() {
                    if (uploadedFiles.length === 0) {
                        return {
                            success: false,
                            message: "No files selected for upload",
                        };
                    }

                    const formData = new FormData();
                    formData.append("action", "upload_book_images");

                    // Add all images
                    uploadedFiles.forEach((file) => {
                        formData.append("images[]", file);
                    });

                    try {
                        const response = await fetch(
                            "../backend/uploads/file_upload_simple.php",
                            {
                                method: "POST",
                                body: formData,
                            }
                        );

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`
                            );
                        }

                        const result = await response.json();
                        console.log("Upload result:", result);

                        if (result.success) {
                            const files = result.files;

                            // Check if files array exists and has content
                            if (
                                !files ||
                                !Array.isArray(files) ||
                                files.length === 0
                            ) {
                                return {
                                    success: false,
                                    message:
                                        "Upload succeeded but no files were returned. Please try again.",
                                };
                            }

                            const coverImagePath = files[0]?.file_path || "";
                            const additionalImagePaths = files
                                .slice(1)
                                .map((f) => f.file_path);

                            // Validate that cover image path is not empty
                            if (
                                !coverImagePath ||
                                coverImagePath.trim() === ""
                            ) {
                                return {
                                    success: false,
                                    message:
                                        "Cover image upload failed. Please try again.",
                                };
                            }

                            return {
                                success: true,
                                coverImagePath,
                                additionalImagePaths,
                            };
                        } else {
                            return result;
                        }
                    } catch (error) {
                        console.error("Upload error:", error);
                        return {
                            success: false,
                            message: "Upload failed: " + error.message,
                        };
                    }
                }

                // Create book in database
                async function createBook(bookData) {
                    const formData = new FormData();
                    formData.append("action", "add_book");

                    // Add all book data
                    Object.keys(bookData).forEach((key) => {
                        formData.append(key, bookData[key]);
                    });

                    try {
                        const response = await fetch(
                            "../backend/books/book_manager.php",
                            {
                                method: "POST",
                                body: formData,
                            }
                        );

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`
                            );
                        }

                        const responseText = await response.text();
                        if (!responseText) {
                            throw new Error("Empty response from server");
                        }

                        return JSON.parse(responseText);
                    } catch (error) {
                        console.error("Create book error:", error);
                        throw new Error(`Network error: ${error.message}`);
                    }
                }

                // Get form data
                function getFormData() {
                    const condMap = {
                        new: "New",
                        excellent: "Excellent",
                        good: "Good",
                        fair: "Fair",
                        poor: "Poor",
                    };

                    const catMap = {
                        fiction: 1,
                        academic: 2,
                        science: 3,
                        business: 4,
                        children: 5,
                        history: 6,
                        biography: 1,
                        "self-help": 7,
                        art: 1,
                        travel: 1,
                        other: 1,
                    };

                    return {
                        title: document
                            .getElementById("book-title")
                            .value.trim(),
                        author: document
                            .getElementById("book-author")
                            .value.trim(),
                        isbn: document.getElementById("book-isbn").value.trim(),
                        description: document
                            .getElementById("book-description")
                            .value.trim(),
                        price: document.getElementById("book-price-input")
                            .value,
                        book_condition:
                            condMap[
                                document.getElementById("book-condition").value
                            ] || "Good",
                        category_id:
                            catMap[
                                document.getElementById("book-category").value
                            ] || 1,
                        stock_quantity:
                            document.getElementById("book-quantity").value ||
                            "1",
                        seller_id:
                            window.bookmarketAuth?.getUserId?.() ||
                            JSON.parse(
                                localStorage.getItem("bookmarket_user") || "{}"
                            ).userId ||
                            JSON.parse(
                                localStorage.getItem("bookmarket_user") || "{}"
                            ).id,
                    };
                }
            });
        </script>
    </body>
</html>
